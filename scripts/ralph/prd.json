{
  "project": "pdfplumber-rs",
  "branchName": "ralph/issue-152-line-clustering",
  "description": "Issue #152: Optimize O(n²) word-to-line clustering using y-coordinate bucketing",
  "relatedIssue": 152,
  "userStories": [
    {
      "id": "US-152-1",
      "title": "Optimize cluster_words_into_lines with y-coordinate bucketing",
      "description": "Refactor the `cluster_words_into_lines` function in `crates/pdfplumber-core/src/layout.rs` (lines 54-103) to eliminate O(n²) complexity. The current implementation iterates through all existing lines for each word to find a match within `y_tolerance`. Replace the linear scan with a y-coordinate bucketing approach: group lines by y-coordinate ranges (buckets of size `y_tolerance`) so that for each new word, only 1-2 relevant buckets are checked instead of all lines. This brings complexity from O(n²) down to approximately O(n). The refactored function must produce identical output for all existing tests. Add a benchmark test with 10,000+ words across many lines to verify performance improvement.",
      "acceptanceCriteria": [
        "cluster_words_into_lines no longer scans all existing lines for each word",
        "Uses bucket/sorted approach for line matching (O(n) or O(n log n) instead of O(n²))",
        "All existing cluster_words_into_lines tests in layout.rs pass without modification",
        "All existing integration tests pass (cargo test --workspace)",
        "New benchmark test with 10,000+ words demonstrates sub-quadratic behavior",
        "Function signature remains unchanged: pub fn cluster_words_into_lines(words: &[Word], y_tolerance: f64) -> Vec<TextLine>",
        "Output ordering (lines top-to-bottom, words left-to-right within each line) is preserved",
        "Edge cases handled: empty input, single word, all words on same line, overlapping y ranges",
        "cargo fmt --all -- --check passes",
        "cargo clippy --workspace -- -D warnings passes",
        "cargo test --workspace passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Key file: crates/pdfplumber-core/src/layout.rs lines 54-103. The current code sorts words by (top, x0) then iterates `lines` vec for each word. A HashMap<i64, usize> keyed by quantized y-coordinate (e.g., (mid_y / y_tolerance) as i64) mapping to line indices would reduce lookups to O(1) amortized. Check adjacent buckets (key-1, key, key+1) to handle boundary cases. Existing tests at lines 314-760 cover many edge cases."
    }
  ]
}
