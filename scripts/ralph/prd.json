{
  "project": "pdfplumber-rs",
  "branchName": "ralph/phase7-differentiation",
  "description": "Phase 7: Differentiation - Visual debugging (SVG), table quality metrics, image content extraction, encrypted PDF support",
  "userStories": [
    {
      "id": "US-067",
      "title": "Visual debugging - SVG page rendering foundation",
      "description": "Generate SVG representations of PDF pages showing page boundaries and coordinate system. This is the foundation for the visual debugging system — Python pdfplumber's most unique feature. SVG is chosen first because it needs no rasterization dependency and is WASM-compatible.",
      "acceptanceCriteria": [
        "SvgRenderer struct that takes a Page and produces SVG markup",
        "Page::to_svg(options) -> String",
        "SvgOptions: width (Option<f64>), height (Option<f64>), scale (f64, default 1.0)",
        "Generated SVG includes: page boundary rectangle, proper viewBox matching page dimensions",
        "SVG coordinate system matches the page's top-left origin system",
        "Output is valid SVG 1.1 (no external dependencies)",
        "Unit tests: SVG generation for simple page, SVG has correct viewBox, valid SVG markup",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Place SvgRenderer in a new module in pdfplumber-core or pdfplumber crate. Pure string generation — no rendering library needed."
    },
    {
      "id": "US-068",
      "title": "Visual debugging - object overlay drawing",
      "description": "Add drawing methods to overlay extracted objects (chars, lines, rects, curves, table cells) on the SVG page image. Reference: pdfplumber(Py) PageImage.draw_rect/draw_line/draw_circle.",
      "acceptanceCriteria": [
        "SvgRenderer::draw_chars(chars, style) — draw character bounding boxes",
        "SvgRenderer::draw_rects(rects, style) — draw rectangle outlines/fills",
        "SvgRenderer::draw_lines(lines, style) — draw line segments",
        "SvgRenderer::draw_edges(edges, style) — draw detected edges",
        "SvgRenderer::draw_tables(tables, style) — draw table cell boundaries",
        "DrawStyle struct: fill (Option<String>), stroke (Option<String>), stroke_width (f64), opacity (f64)",
        "Default styles: chars=blue outline, lines=red, rects=green, tables=lightblue fill",
        "Add `pdfplumber debug <FILE> --output <file.svg>` CLI subcommand",
        "Unit tests: SVG with char overlays, SVG with mixed objects, style customization",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "This + US-069 together recreate Python pdfplumber's visual debugging capability."
    },
    {
      "id": "US-069",
      "title": "Visual debugging - debug_tablefinder SVG",
      "description": "Generate a debug SVG showing the table detection pipeline: detected edges (red), intersection points (circles), and table regions (shaded). Reference: pdfplumber(Py) PageImage.debug_tablefinder().",
      "acceptanceCriteria": [
        "Page::debug_tablefinder_svg(settings, options) -> String",
        "SVG shows: all detected edges in red, intersection points as small circles, table bboxes as light blue rectangles, cell boundaries as dashed lines",
        "Uses TableFinder intermediate results: edges, intersections, cells, tables",
        "SvgDebugOptions: show_edges (bool), show_intersections (bool), show_cells (bool), show_tables (bool), all default true",
        "Add `pdfplumber debug <FILE> --tables --output <file.svg>` CLI flag",
        "Unit tests: debug SVG for page with table, debug SVG for page without tables",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Depends on US-067 and US-068. This is the killer debugging feature."
    },
    {
      "id": "US-070",
      "title": "Table extraction quality metrics",
      "description": "Calculate accuracy and whitespace quality scores for extracted tables, allowing programmatic filtering of bad extractions. Reference: Camelot table.accuracy, table.whitespace.",
      "acceptanceCriteria": [
        "Table::accuracy() -> f64 — percentage of cells with non-empty text (0.0 to 1.0)",
        "Table::whitespace() -> f64 — average ratio of whitespace in cell text (0.0 to 1.0, lower is better)",
        "TableQuality struct: accuracy (f64), whitespace (f64)",
        "Table::quality() -> TableQuality for combined metrics",
        "Include quality metrics in JSON output of CLI `tables` subcommand",
        "Optional: TableSettings::min_accuracy to auto-filter low-quality tables",
        "Unit tests: table with all cells filled (high accuracy), table with many empty cells (low accuracy), whitespace calculation",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Simple computation on existing Table data. Add to pdfplumber-core Table struct."
    },
    {
      "id": "US-071",
      "title": "Image content extraction - raw bytes",
      "description": "Extract actual image data (raw bytes) from PDF image XObjects, not just metadata. Decode common image filters. Currently pdfplumber-rs only extracts image metadata (bbox, dimensions, colorspace).",
      "acceptanceCriteria": [
        "ImageContent struct: data (Vec<u8>), format (ImageFormat), width (u32), height (u32)",
        "ImageFormat enum: Jpeg, Png, Raw, Jbig2, CcittFax",
        "Image::extract_content(doc) -> Result<ImageContent, PdfError>",
        "Decode DCTDecode (JPEG): return raw JPEG bytes directly",
        "Decode FlateDecode: decompress and return raw pixel data",
        "Handle multiple chained filters (e.g., FlateDecode + DCTDecode)",
        "Page::extract_images_with_content() -> Vec<(Image, ImageContent)>",
        "Add `pdfplumber images <FILE> --extract --output-dir <DIR>` CLI subcommand to save images to disk",
        "Unit tests: extract JPEG image, extract FlateDecode image, image with no content stream",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Requires access to the PDF document for stream decoding. Add image extraction to pdfplumber-parse, types to pdfplumber-core."
    },
    {
      "id": "US-072",
      "title": "Encrypted PDF support - password-based decryption",
      "description": "Support opening password-protected PDFs. A significant portion of real-world PDFs are encrypted. PyMuPDF, pikepdf, pypdf, PDFBox, and pdfcpu all handle this.",
      "acceptanceCriteria": [
        "Pdf::open_with_password(bytes, password, options) -> Result<Pdf, PdfError>",
        "Support user password and owner password",
        "Support RC4 encryption (40-bit, 128-bit)",
        "Support AES encryption (128-bit, 256-bit)",
        "PdfError::PasswordRequired variant when encrypted PDF opened without password",
        "PdfError::InvalidPassword variant when wrong password provided",
        "Add --password <PASSWORD> flag to all CLI subcommands",
        "Unit tests: open encrypted PDF with correct password, wrong password error, unencrypted PDF ignores password",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "lopdf has some encryption support. Check lopdf::Document::decrypt() capabilities. May need to add decryption crate as dependency if lopdf support is insufficient."
    }
  ]
}
