{
  "project": "pdfplumber-rs",
  "branchName": "ralph/phase1-foundation",
  "description": "Phase 1: Foundation - Workspace setup, PDF parsing backend, content stream interpreter, character extraction",
  "userStories": [
    {
      "id": "US-001",
      "title": "Workspace scaffolding - 3-crate workspace setup",
      "description": "Set up the Rust workspace with three crates: pdfplumber-core (backend-independent algorithms), pdfplumber-parse (PDF parsing + interpreter), and pdfplumber (public API facade). Include Cargo.toml workspace configuration, edition 2024, MSRV 1.85, and basic lib.rs for each crate.",
      "acceptanceCriteria": [
        "Workspace Cargo.toml at project root with members: crates/pdfplumber-core, crates/pdfplumber-parse, crates/pdfplumber",
        "Each crate has its own Cargo.toml with edition = '2024' and rust-version = '1.85'",
        "pdfplumber depends on pdfplumber-core and pdfplumber-parse",
        "pdfplumber-parse depends on pdfplumber-core",
        "pdfplumber-core has no external dependencies (pure algorithms)",
        "Each crate has a lib.rs with a basic module structure comment",
        "cargo check --workspace passes",
        "cargo test --workspace passes (even if no tests yet)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Already completed and merged to main."
    },
    {
      "id": "US-002",
      "title": "Core data model - BBox, Color, TextDirection, Orientation types",
      "description": "Define the foundational data types in pdfplumber-core that all layers depend on: BBox (bounding box with x0/top/x1/bottom), Color enum, TextDirection, Orientation, and basic type implementations.",
      "acceptanceCriteria": [
        "BBox struct with x0, top, x1, bottom (f64) + width()/height() methods",
        "Color enum: Gray(f32), Rgb(f32, f32, f32), Cmyk(f32, f32, f32, f32), Other(Vec<f32>)",
        "TextDirection enum: Ltr, Rtl, Ttb, Btt",
        "Orientation enum: Horizontal, Vertical, Diagonal",
        "All types derive Debug, Clone, Copy (where possible), PartialEq",
        "Unit tests: BBox construction, width/height calculation, edge cases (zero-size bbox)",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Completed. Color changed from struct to enum (Gray/Rgb/Cmyk/Other). Orientation enum added to geometry.rs. LineOrientation kept as type alias."
    },
    {
      "id": "US-003",
      "title": "Core data model - Char, Word, Line, Rect, Curve, Edge, Image types",
      "description": "Define all extraction result types in pdfplumber-core: Char (text + bbox + font info), Word, Line, Rect, Curve, Edge (with EdgeSource), and Image. These match Python pdfplumber's object model.",
      "acceptanceCriteria": [
        "Char struct: text, fontname, size, bbox, doctop, upright, direction, stroking_color, non_stroking_color, ctm, char_code",
        "Word struct: text, bbox, doctop, direction, chars",
        "Line struct: x0, y0, x1, y1, width, orientation, stroking_color",
        "Rect struct: bbox, width, fill, stroke, stroking_color, non_stroking_color",
        "Curve struct: points, width, fill, stroke",
        "Edge struct: x0, y0, x1, y1, orientation, source (EdgeSource enum)",
        "Image struct: bbox, width, height, colorspace, bits_per_component, name",
        "Unit tests: construction and field access for each type",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Char extended with doctop, upright, direction, stroking_color, non_stroking_color, ctm, char_code. Word extended with doctop, direction. Line/Rect/Curve/Edge/Image already existed from Phase 2. Construction and field access tests added for all types."
    },
    {
      "id": "US-004",
      "title": "Error and warning model",
      "description": "Define the error and warning types for the library. Errors stop processing; warnings allow best-effort continuation. Include ExtractResult<T> wrapper and ExtractOptions with resource limits.",
      "acceptanceCriteria": [
        "PdfError enum in pdfplumber-core: ParseError, IoError, FontError, InterpreterError, ResourceLimitExceeded, Other",
        "ExtractWarning struct: description, source location (page/element context)",
        "ExtractResult<T> struct: value: T, warnings: Vec<ExtractWarning>",
        "ExtractOptions struct: max_recursion_depth, max_objects_per_page, max_stream_bytes, collect_warnings with sensible defaults",
        "thiserror integration for PdfError in pdfplumber-parse",
        "Unit tests: error creation, warning collection, ExtractResult usage",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "PdfError in pdfplumber-core with manual Error impl. BackendError in pdfplumber-parse with thiserror. ExtractWarning has description + optional page/element context. ExtractOptions with sensible defaults (10 recursion, 100K objects, 100MB streams)."
    },
    {
      "id": "US-005",
      "title": "PdfBackend trait definition",
      "description": "Define the PdfBackend trait in pdfplumber-parse that abstracts PDF parsing. This trait enables pluggable backends (lopdf by default, pdf-rs as alternative). Include ContentHandler callback trait for interpreter.",
      "acceptanceCriteria": [
        "PdfBackend trait with associated types: Document, Page, Error",
        "Methods: open(bytes) -> Document, page_count, get_page, page_media_box, page_crop_box, page_rotate",
        "interpret_page method that takes a ContentHandler callback",
        "ContentHandler trait with callbacks for text operations, path operations, image operations",
        "All trait methods properly documented with doc comments",
        "Unit tests: mock backend implementation to verify trait contract",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "PdfBackend trait with associated types (Document, Page, Error). ContentHandler trait with CharEvent/PathEvent/ImageEvent callbacks. Default no-op implementations allow selective handler subscription. Mock backend tests verify the trait contract."
    },
    {
      "id": "US-006",
      "title": "lopdf backend - document open, page count, page access",
      "description": "Implement PdfBackend for lopdf: open PDF from bytes, count pages, access individual pages. This is the foundation for all PDF reading.",
      "acceptanceCriteria": [
        "LopdfBackend struct implementing PdfBackend trait",
        "open() parses PDF bytes via lopdf::Document::load_mem()",
        "page_count() returns correct number of pages",
        "get_page() returns page by 0-based index",
        "Proper error mapping from lopdf errors to PdfError",
        "Integration test with a minimal PDF fixture (create programmatically with lopdf if possible)",
        "Unit tests: open valid PDF, open invalid bytes (error case), page count, page access, out-of-bounds page",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "LopdfBackend implements PdfBackend for open/page_count/get_page. lopdf 0.34 added as dependency. LopdfDocument wraps lopdf::Document + cached page_ids. LopdfPage holds ObjectId + index. Stub methods for page_media_box/page_crop_box/page_rotate/interpret_page (US-007+). Test PDFs created programmatically with lopdf."
    },
    {
      "id": "US-007",
      "title": "lopdf backend - MediaBox, CropBox, Rotate extraction",
      "description": "Implement page_media_box, page_crop_box, and page_rotate for the lopdf backend. These are essential for coordinate system setup.",
      "acceptanceCriteria": [
        "page_media_box() extracts /MediaBox array from page or inherited from parent",
        "page_crop_box() extracts /CropBox if present (returns None otherwise)",
        "page_rotate() extracts /Rotate value (0/90/180/270, default 0)",
        "Handle inheritance: if page lacks MediaBox, walk up page tree to find it",
        "Unit tests: page with explicit MediaBox, inherited MediaBox, CropBox present/absent, various Rotate values",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "page_media_box with inheritance via resolve_inherited helper. page_crop_box reads from page dict only (no inheritance). page_rotate with inheritance, defaults to 0. Helper functions: extract_bbox_from_array, object_to_f64, resolve_inherited."
    },
    {
      "id": "US-008",
      "title": "Content stream tokenizer - operator and operand parsing",
      "description": "Implement a content stream tokenizer that parses PDF content stream bytes into a sequence of operators with their operands. This is the foundation for the interpreter.",
      "acceptanceCriteria": [
        "Operand enum: Integer, Real, Name, String (byte/hex), Array, Boolean, Null",
        "Operator struct: name (String), operands (Vec<Operand>)",
        "Tokenizer parses content stream bytes into Vec<Operator>",
        "Handle: numbers (int/float), names (/Name), strings (literal and hex), arrays, inline images (BI/ID/EI)",
        "Handle comments (% to end of line)",
        "Unit tests: parse each operand type, parse common operators (BT, ET, Tf, Td, Tj, TJ, m, l, re, S, f), parse mixed streams",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Tokenizer in pdfplumber-parse. Operand enum (Integer/Real/Name/LiteralString/HexString/Array/Boolean/Null), Operator struct, tokenize() function. Handles comments, inline images (BI/ID/EI), escape sequences, hex strings, balanced parens, octal escapes, #XX name escapes. 48 unit tests."
    },
    {
      "id": "US-009",
      "title": "Graphics state stack - q/Q, cm, CTM management",
      "description": "Implement the graphics state stack for the content stream interpreter. Handles save/restore (q/Q), current transformation matrix (cm), and state tracking.",
      "acceptanceCriteria": [
        "GraphicsState struct: ctm (6-element matrix), line_width, stroking_color, non_stroking_color, dash_pattern, and other state fields",
        "StateStack: push (q), pop (Q) with full state save/restore",
        "CTM operations: cm operator applies matrix multiplication",
        "Matrix utility functions: multiply, transform_point, identity",
        "Color setting operators: CS/cs, SC/SCN/sc/scn, G/g, RG/rg, K/k",
        "Unit tests: push/pop state, CTM multiplication, point transformation, color state tracking",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "InterpreterState in pdfplumber-parse bundles Ctm + GraphicsState + state stack. q/Q push/pop full state (CTM + graphics). cm pre-multiplies new matrix onto CTM. Color operators: G/g (gray), RG/rg (RGB), K/k (CMYK), SC/SCN/sc/scn (generic via component count). Also w (line width), d (dash pattern). 38 unit tests."
    },
    {
      "id": "US-010",
      "title": "Text state machine - BT/ET, Tf, Tm, Td, positioning operators",
      "description": "Implement the text state machine that tracks font, text matrix, line matrix, and text positioning across BT/ET blocks.",
      "acceptanceCriteria": [
        "TextState struct: font_name, font_size, char_spacing (Tc), word_spacing (Tw), h_scaling (Tz), leading (TL), rise (Ts), render_mode (Tr)",
        "Text matrix (Tm) and line matrix tracking",
        "BT resets text matrix to identity; ET ends text block",
        "Tf sets font and size",
        "Tm sets text matrix directly",
        "Td/TD move text position (TD also sets leading)",
        "T* moves to start of next line using leading",
        "Unit tests: state initialization, Tf changes, Td positioning, TD with leading, T* newline, Tm direct set",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "TextState in pdfplumber-parse. TextRenderMode enum (0-7). BT resets text/line matrices to identity. ET clears in_text_object. Tf sets font_name/font_size. Tm replaces (not concatenates) both matrices. Td pre-multiplies translation onto line_matrix, copies to text_matrix. TD sets leading=-ty then calls Td. T* calls Td(0,-leading). advance_text_position pre-multiplies horizontal translation onto text_matrix only. Text state params (Tc/Tw/Tz/TL/Tr/Ts) persist across BT/ET."
    },
    {
      "id": "US-011",
      "title": "Text rendering operators - Tj, TJ, quote operators → glyph extraction",
      "description": "Implement text rendering operators that produce glyph/character output: Tj (show string), TJ (show with positioning), ' (move + show), \" (set spacing + show).",
      "acceptanceCriteria": [
        "Tj operator: decode string bytes → glyph codes, advance text position by glyph widths",
        "TJ operator: process array of strings and numeric adjustments (kerning)",
        "' operator: equivalent to T* then Tj",
        "\" operator: set word spacing (aw), char spacing (ac), then show string",
        "Each glyph produces a RawChar with: char_code, displacement, text_matrix snapshot",
        "Integration with TextState for proper position tracking",
        "Unit tests: Tj with simple string, TJ with kerning, ' and \" operators, position tracking across multiple operators",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "RawChar struct captures char_code + displacement + text_matrix snapshot. TjElement enum for TJ arrays. Functions: show_string (Tj), show_string_with_positioning (TJ), quote_show_string ('), double_quote_show_string (\"). Width lookup via callback (dyn Fn(u32)->f64). Single-byte encoding (each byte = char code). 34 unit tests."
    },
    {
      "id": "US-012",
      "title": "ToUnicode CMap parsing - bfchar and bfrange mapping",
      "description": "Implement ToUnicode CMap parser to convert glyph codes to Unicode text. This handles the most common case for modern PDFs.",
      "acceptanceCriteria": [
        "CMap parser: parse beginbfchar/endbfchar entries (code → unicode)",
        "CMap parser: parse beginbfrange/endbfrange entries (code range → unicode range)",
        "Handle UTF-16BE encoded Unicode values in CMap",
        "Handle multi-byte source codes (1-2 byte CID codes)",
        "CMap::lookup(code) -> Option<String> for character mapping",
        "Fallback: if no mapping found, return U+FFFD or raw code representation",
        "Unit tests: simple bfchar mapping, bfrange mapping, UTF-16BE surrogate pairs, missing mapping fallback",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Place CMap parser in pdfplumber-parse. It needs to handle the CMap syntax from PDF spec."
    },
    {
      "id": "US-013",
      "title": "Font metrics - glyph widths from /Widths and /FontDescriptor",
      "description": "Extract font metrics (glyph widths, ascent, descent) from PDF font dictionaries to calculate accurate character bounding boxes.",
      "acceptanceCriteria": [
        "Parse /Widths array for Type1 and TrueType fonts",
        "Parse /FontDescriptor for /Ascent, /Descent, /FontBBox",
        "Handle /FirstChar and /LastChar for width array indexing",
        "Handle /MissingWidth for characters outside the range",
        "FontMetrics struct: get_width(char_code) -> f64, ascent, descent",
        "Default metrics when font info is incomplete (best-effort with warning)",
        "Unit tests: width lookup, out-of-range fallback, FontDescriptor parsing, missing metrics handling",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Char BBox calculation - CTM + text state → final coordinates",
      "description": "Combine font metrics, text state, and CTM to calculate the final bounding box for each character in top-left origin coordinates.",
      "acceptanceCriteria": [
        "Calculate character width in user space: glyph_width * font_size / 1000 * h_scaling + char_spacing (+ word_spacing for space)",
        "Calculate character height from font ascent/descent metrics",
        "Apply text matrix and CTM to get position in page coordinates",
        "Convert from PDF bottom-left origin to top-left origin (y-flip using page height)",
        "Handle text rise (Ts) for superscript/subscript",
        "Produce Char struct with all fields populated",
        "Unit tests: simple horizontal text bbox, scaled text, text with rise, rotated text matrix, CTM transformation",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": "This is where Layer 2 (interpreter) feeds into Layer 3 (object extraction)."
    },
    {
      "id": "US-015",
      "title": "Page rotation + CropBox coordinate normalization",
      "description": "Apply /Rotate and CropBox transforms so that all output coordinates are in the 'user-visible page' coordinate system (top-left origin, rotation applied).",
      "acceptanceCriteria": [
        "Transform function that takes raw coordinates + page rotation + MediaBox + CropBox → normalized coordinates",
        "Rotation 0: identity (just y-flip)",
        "Rotation 90: x,y swap with appropriate offsets",
        "Rotation 180: both axes flipped",
        "Rotation 270: x,y swap with different offsets",
        "CropBox clips and offsets coordinates when present",
        "Page width/height reflect the rotated dimensions",
        "Unit tests: each rotation value (0/90/180/270), CropBox offset, combined rotation + CropBox",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": "Centralize this in a single transform module for consistency."
    },
    {
      "id": "US-016",
      "title": "Form XObject (Do operator) - recursive content stream processing",
      "description": "Handle the Do operator for Form XObjects: when the interpreter encounters a Form XObject reference, recursively process its content stream with the XObject's transform matrix.",
      "acceptanceCriteria": [
        "Detect Do operator in content stream and resolve XObject reference",
        "Distinguish Form XObject from Image XObject",
        "For Form XObject: save state, apply XObject matrix, process inner content stream, restore state",
        "Respect max_recursion_depth from ExtractOptions to prevent infinite recursion",
        "Accumulate chars/paths from nested XObjects into the page result",
        "Handle XObject resource dictionaries (fonts, nested XObjects)",
        "Unit tests: page with Form XObject containing text, nested XObjects (2 levels), recursion limit enforcement",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": "Critical for many real-world PDFs where content is wrapped in Form XObjects."
    },
    {
      "id": "US-017",
      "title": "Public API - Pdf::open(), Page::chars(), extract_text(layout=false)",
      "description": "Wire everything together into the public API in the pdfplumber crate: open a PDF from bytes, access pages, get characters, and extract plain text.",
      "acceptanceCriteria": [
        "Pdf::open(bytes, options) -> Result<Pdf, PdfError> in pdfplumber crate",
        "Pdf::page_count() -> usize",
        "Pdf::page(index) -> Result<Page, PdfError> (0-indexed)",
        "Page::chars() -> &[Char] returns all characters with coordinates",
        "Page::extract_text(options) -> String for layout=false (line-based join)",
        "Page metadata: page_number(), width(), height(), rotation(), bbox()",
        "doctop calculation across pages",
        "Integration test with a real PDF fixture containing English text",
        "Unit tests: open PDF, access page, verify char coordinates, extract text output",
        "cargo test --workspace passes",
        "cargo clippy --workspace -- -D warnings passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": "This is the capstone story for Phase 1. Everything must work end-to-end."
    }
  ]
}
