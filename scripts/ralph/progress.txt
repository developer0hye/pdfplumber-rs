## Codebase Patterns

- **PDF test fixture creation**: Use lopdf programmatically to create minimal PDFs for testing. Pattern: create font → content stream → resources → page → pages tree → catalog → save to bytes. See `create_pdf_with_content()` in `crates/pdfplumber/src/pdf.rs`.
- **ContentHandler collecting pattern**: Implement a `CollectingHandler` that stores `CharEvent`s and `ImageEvent`s during `interpret_page`, then convert them to `Char`s and `Image`s afterward using `char_from_event` and `image_from_ctm`.
- **CharEvent → Char conversion**: Use `FontMetrics::default_metrics()` (ascent=750, descent=-250) when per-font metrics aren't available. The displacement (glyph width) in CharEvent already comes from actual font metrics in the interpreter.
- **doctop calculation**: Accumulate display page heights (`PageGeometry::height()`) for pages before the current one. Offset each char's doctop by this sum.
- **Page parent reference**: When building PDFs with lopdf, create the page first, then the pages tree, then update the page's Parent reference afterward (circular reference workaround).

# Ralph Progress Log
Started: 2026년  2월 28일 토요일 08시 48분 05초 KST
---

## 2026-02-28 - US-017
- What was implemented: Public API facade wiring the full extraction pipeline
  - `Pdf` struct with `open()`, `page_count()`, `page()` methods
  - `Page::rotation()`, `Page::bbox()` accessors
  - `CollectingHandler` for content stream event collection
  - `CharEvent` → `Char` conversion via `char_from_event`
  - `ImageEvent` → `Image` conversion via `image_from_ctm`
  - `doctop` calculation across multiple pages
  - 20 unit tests + 10 integration tests with programmatic PDF fixtures
- Files changed:
  - `crates/pdfplumber/src/pdf.rs` (new - Pdf struct, CollectingHandler, tests)
  - `crates/pdfplumber/src/page.rs` (added rotation field, bbox(), from_extraction())
  - `crates/pdfplumber/src/lib.rs` (added mod pdf, pub use Pdf)
  - `crates/pdfplumber/Cargo.toml` (added lopdf dev-dependency)
  - `crates/pdfplumber/tests/pdf_integration.rs` (new - end-to-end tests)
- Dependencies added: lopdf 0.34 (dev-dependency only, for test PDF creation)
- **Learnings for future iterations:**
  - CharEvent doesn't carry color info or font ascent/descent. Colors are set to None for now. Font metrics use defaults. These could be enhanced by adding fields to CharEvent.
  - Path operators (m, l, re, S, f, etc.) are not yet implemented in the interpreter, so Page.lines/rects/curves are empty when extracted via Pdf::page().
  - The raw PDF MediaBox height must be used for char_from_event y-flip (not the display height after rotation/crop).
  - lopdf's Document::save_to() handles xref table and trailer automatically.
---
