# Ralph Progress Log
Started: 2026년  3월  1일 일요일 03시 06분 03초 KST
---

## Codebase Patterns
- Text rendering operators (Tj, TJ, ', ") flow: interpret_content_stream → handle_tj/handle_tj_array → emit_char_events → handler.on_char(CharEvent)
- The tokenizer's Operand enum now includes Dictionary(Vec<(String, Operand)>) for inline `<<...>>` dicts
- Marked content state is NOT part of graphics state (q/Q don't save/restore it), so it's tracked as a local `Vec<MarkedContentEntry>` in interpret_content_stream
- To thread new state through char emission: add parameter to handle_tj → handle_tj_array → emit_char_events chain
- Warning types are in `crates/pdfplumber-core/src/error.rs` — ExtractWarning, ExtractWarningCode, ExtractOptions, PdfError
- Re-exports from `crates/pdfplumber-core/src/lib.rs`
- Warning emission sites are in `crates/pdfplumber-parse/src/interpreter.rs` (3 font-related sites)
- serde support uses conditional derive: `#[cfg_attr(feature = "serde", derive(serde::Serialize, serde::Deserialize))]`
- All ExtractOptions struct literals in tests use `..ExtractOptions::default()` spread, so adding new fields with defaults is backward-compatible
- pdfplumber-py tests fail in local env due to missing libpython3.11.dylib — pre-existing issue, skip with `-p` flags
- PdfError::ResourceLimitExceeded is a struct variant: `{ limit_name: String, limit_value: usize, actual_value: usize }`
- Document-level budgets are `Option<usize>` fields on ExtractOptions (None=no limit for backward compat)
- max_input_bytes checked in Pdf::open before parsing; max_pages checked in from_doc after page_count
- Accumulated counters (total_objects, total_image_bytes) use AtomicUsize in Pdf struct for thread safety with pages_parallel()

---

## 2026-03-01 - US-092
- **What was implemented**: Tagged PDF operators (BMC/BDC/EMC) wired in content stream interpreter
- **Learnings for future iterations:**
  - MCID inheritance in nested content uses `iter().rev().find_map()` to find nearest ancestor with MCID
  - Tag always comes from the innermost (last) stack entry
  - EMC on empty stack is gracefully ignored (no panic)
---

## 2026-03-01 - US-093
- **What was implemented**: Added `duplicate_merged_content: bool` to `TableSettings`
- **Learnings for future iterations:**
  - Merged cells create larger cells covering multiple grid positions
  - Center-point containment (with epsilon tolerance) is used to match sub-grid positions
---

## 2026-03-01 - US-094
- **What was implemented**: Added automatic header/footer detection and removal
- **Learnings for future iterations:**
  - Digit masking is effective for detecting repeating text with variable page numbers
  - `detect_page_regions` is a pure function on text data
---

## 2026-03-01 - US-095
- **What was implemented**: Multi-column layout reading order improvement
- **Learnings for future iterations:**
  - Column detection clusters inter-word gaps within lines
  - Section-based approach handles heading-columns-footer patterns
---

## 2026-03-01 - US-096 (Phase 13)
- Implemented ExtractWarningCode enum: MissingFont, UnsupportedOperator, MalformedObject, ResourceLimitReached, EncodingFallback, Other(String)
- ExtractWarning gained `code` field, Display format changed to `[CODE] message (page N)`
- ExtractOptions gained `strict_mode` (bool, default false)
- All 3 interpreter warning emission sites updated to use MissingFont code
- Added set_code() builder and to_error() for strict mode escalation
- serde serialization with tagged enum for ExtractWarningCode
- 15 new tests, all passing (42 total in error module)
- Files changed:
  - crates/pdfplumber-core/src/error.rs (main implementation + tests)
  - crates/pdfplumber-core/src/lib.rs (re-export ExtractWarningCode)
  - crates/pdfplumber-parse/src/interpreter.rs (import + warning code updates)
- **Learnings for future iterations:**
  - Existing constructors (new, on_page, with_context, with_operator_context) default to Other code
  - Use set_code() builder pattern to override after construction
  - Existing tests check .description field, not Display output, so Display format changes don't break them
---

## 2026-03-01 - US-097 (Phase 13)
- Implemented document-level resource budgets for production safety
- PdfError::ResourceLimitExceeded changed from `(String)` to struct variant `{ limit_name, limit_value, actual_value }`
- ExtractOptions gained 4 new `Option<usize>` fields: max_input_bytes, max_pages, max_total_image_bytes, max_total_objects
- All default to None (no limit) for backward compatibility
- max_input_bytes: checked in Pdf::open() before parsing
- max_pages: checked in from_doc() after getting page_count
- max_total_objects: AtomicUsize counter in Pdf, checked after each page() extraction (chars+lines+rects+curves+images)
- max_total_image_bytes: AtomicUsize counter in Pdf, checked after each page() extraction (sum of image data bytes)
- 10 new tests: 7 integration (rejects/allows/disabled), 3 unit (defaults, custom, clone)
- Files changed:
  - crates/pdfplumber-core/src/error.rs (struct variant + new fields + tests)
  - crates/pdfplumber/src/pdf.rs (budget checks + AtomicUsize counters)
  - crates/pdfplumber/tests/pdf_integration.rs (7 integration tests)
  - crates/pdfplumber-parse/src/error.rs (updated test for struct variant)
  - crates/pdfplumber-py/src/lib.rs (updated match arm + test)
- **Learnings for future iterations:**
  - Pdf doesn't implement Debug, so can't use unwrap_err() in tests — use match patterns instead
  - AtomicUsize with Relaxed ordering is sufficient for counters since exact accuracy isn't critical
  - fetch_add returns the *previous* value, so add page_object_count to get the new total
---

## 2026-03-01 - US-098 (Phase 13)
- Implemented deterministic image naming and export contract
- ImageExportOptions struct: pattern (String, default "page{page}_img{index}.{ext}"), deduplicate (bool, default false)
- ExportedImage struct: filename, data, mime_type, page (1-indexed)
- ImageFilter::extension() for normalized file extensions (DCTDecode->jpg, FlateDecode->png, JPXDecode->jp2, CCITTFaxDecode->tiff, others->bin)
- content_hash_prefix() for deterministic SipHash-based content hashing (16 hex chars)
- apply_export_pattern() for {page}, {index}, {ext}, {hash} variable substitution
- export_image_set() core function handles deduplication via HashMap of hash->filename
- Page::export_images(options) delegates to export_image_set with 1-indexed page number
- 20 new tests: extension normalization, pattern substitution, deduplication, determinism, edge cases
- Files changed:
  - crates/pdfplumber-core/src/images.rs (new types + methods + tests)
  - crates/pdfplumber-core/src/lib.rs (re-exports)
  - crates/pdfplumber/src/page.rs (export_images method)
  - crates/pdfplumber/src/lib.rs (re-exports)
  - scripts/ralph/prd.json (US-098 passes: true)
- **Learnings for future iterations:**
  - Image.data is Option<Vec<u8>> — requires extract_image_data:true in ExtractOptions to be populated
  - export_image_set is a pure function on &[Image] — easily testable without Page
  - DefaultHasher::new() uses SipHash with keys (0,0) — deterministic within same Rust version
  - ImageFilter::extension() is separate from ImageFormat::extension() — different enums for different contexts
  - Deduplication uses seen_hashes HashMap to map content hash -> first-assigned filename
---
