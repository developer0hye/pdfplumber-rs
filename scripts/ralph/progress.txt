# Ralph Progress Log
Started: 2026년  3월  1일 일요일 04시 55분 12초 KST

## Codebase Patterns
- Font metrics: `FontMetrics` struct in `crates/pdfplumber-parse/src/font_metrics.rs`, widths in glyph space (1/1000 em)
- Standard font data: `StandardFontData` in `crates/pdfplumber-parse/src/standard_fonts.rs`, `lookup(name)` returns `Option<&'static StandardFontData>`
- Subset prefix stripping: `crate::cid_font::strip_subset_prefix()` handles `ABCDEF+FontName` patterns
- Width arrays use WinAnsiEncoding char code mapping (most common in modern PDFs)
- Oblique variants share width data with upright: Helvetica-Oblique = Helvetica, Helvetica-BoldOblique = Helvetica-Bold
- All Courier variants share one array (monospaced, all 600)
- Standard font fallback: `lookup_standard_font(font_dict)` in `font_metrics.rs` — reads `/BaseFont`, strips subset prefix, looks up standard widths
- When standard font matched: widths cover codes 0-255, `first_char=0`, `last_char=255`; descriptor values override standard defaults
- pdfplumber-py tests SIGABRT on macOS (pre-existing, unrelated to standard font work)

---

## 2026-03-01 - US-103
- Created `crates/pdfplumber-parse/src/standard_fonts.rs` with `StandardFontData` struct and `lookup()` function
- Added static width arrays for all 14 standard Type1 fonts (9 unique arrays, shared via match arms)
- Width data sourced from Adobe AFM specifications, indexed by WinAnsiEncoding char codes
- Registered `pub mod standard_fonts;` in `crates/pdfplumber-parse/src/lib.rs`
- 11 unit tests: known widths, all 14 fonts present, unknown returns None, Courier uniform 600, proportional checks
- Files changed: `crates/pdfplumber-parse/src/standard_fonts.rs` (new), `crates/pdfplumber-parse/src/lib.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - AFM files use StandardEncoding char codes; need WinAnsiEncoding mapping for modern PDFs
  - Codes 39 (quotesingle vs quoteright) and 96 (grave vs quoteleft) differ between encodings
  - Symbol and ZapfDingbats use their own built-in encodings, not WinAnsiEncoding
---

## 2026-03-01 - US-104
- Integrated standard font fallback in `extract_font_metrics()` in `crates/pdfplumber-parse/src/font_metrics.rs`
- When `/Widths` is absent and `/BaseFont` matches a Standard 14 font, uses standard widths instead of DEFAULT_WIDTH=600
- Added `lookup_standard_font()` helper that reads `/BaseFont`, strips subset prefix, and calls `standard_fonts::lookup()`
- Standard `font_bbox` used as fallback when `/FontDescriptor` lacks bbox; descriptor ascent/descent always takes precedence
- 10 new unit tests covering: Helvetica/Courier/Times-Roman fallback, subset prefix handling, unknown font default, embedded widths unaffected, descriptor overrides, bbox fallback
- Regenerated anytomd golden files (`business-report`, `technical-doc`) — headings now correctly group words (e.g., "# API Reference Guide" instead of separate "# API" "# Reference" "# Guide")
- Files changed: `crates/pdfplumber-parse/src/font_metrics.rs`, `tests/anytomd/fixtures/business-report/expected_markdown.md`, `tests/anytomd/fixtures/technical-doc/expected_markdown.md`
- Dependencies added: none
- **Learnings for future iterations:**
  - Standard font fallback improves text grouping quality — proportional widths produce correct x-positions for word boundary detection
  - `lopdf::Object::as_name()` returns `&[u8]`, needs `std::str::from_utf8()` conversion
  - Existing tests may break when behavior changes are intentional improvements — update assertions to match new correct behavior
---
