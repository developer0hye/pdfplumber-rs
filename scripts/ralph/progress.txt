## Codebase Patterns
- **PyO3 module name conflict**: The pymodule function name `pdfplumber` conflicts with the external crate name `pdfplumber`. Use `::pdfplumber` to reference the external crate in imports.
- **lopdf dictionary macro**: In Rust 2024 edition, `lopdf::dictionary!` macro requires explicit import: `use lopdf::dictionary;`
- **Test PDFs**: Create minimal PDFs programmatically using `lopdf::Document::with_version("1.7")` + manual page tree construction. See `crates/pdfplumber-py/src/lib.rs` tests for pattern.
- **AcroForm field tree**: Form fields live in `/AcroForm` dictionary (document catalog), not in page `/Annots`. Walk `/Fields` array recursively via `/Kids`. Field type `/FT` can be inherited from parent nodes. Terminal fields have no `/Kids` with `/T` entries.
- **Form field page association**: Use `/P` reference in field dictionary to map fields to pages. Not all fields have `/P`, so `page_index` is `Option<usize>`.
- **Workspace member addition**: Add new crates to root `Cargo.toml` `[workspace] members` array.
- **Crate lib naming**: When lib name differs from package name (e.g., `name = "pdfplumber"` in pdfplumber-py), use `[lib] name = "pdfplumber"` in Cargo.toml.
- **PyO3 extension-module feature**: Must be a Cargo feature flag, NOT a direct pyo3 dependency feature. Direct use prevents test linking. Use `features = ["extension-module"]` in `[features]` and activate via maturin's `pyproject.toml`.
- **PyO3 test setup**: Add `pyo3 = { version = "0.24", features = ["auto-initialize"] }` in `[dev-dependencies]` and add `"rlib"` to `crate-type` for test linking. Set `doctest = false` to avoid rlib name collision with the `pdfplumber` crate.
- **Rust→Python dict conversion**: Use `PyDict::new(py)` + `set_item()` for converting Rust structs to Python dicts. For `Option<T>`, use `py.None()` for the None case.
- **wasm-bindgen non-wasm targets**: `JsError::new()` panics on non-wasm targets ("cannot call wasm-bindgen imported functions"). Test error paths via underlying Rust API instead of through wasm-bindgen wrappers.
- **wasm-bindgen crate setup**: Use `crate-type = ["cdylib", "rlib"]` (cdylib for wasm-pack output, rlib for tests). Set `doctest = false` to avoid issues.
- **serde_wasm_bindgen**: Use `serde_wasm_bindgen::to_value()` for complex Rust→JsValue conversion. Enable `serde` feature on the pdfplumber dependency.
- **WASM pdfplumber dependency**: Use `default-features = false, features = ["serde"]` to disable filesystem APIs (`open_file`) and enable serialization.

---

# Ralph Progress Log - Phase 9: Enterprise - PDF Validation, Repair, Advanced Color Spaces, Digital Signatures
Started: 2026년  2월 28일 토요일 19시 59분 29초 KST
---

## 2026-02-28 - US-082: PDF validation and error reporting
- Implemented ValidationIssue struct (severity, code, message, location) and Severity enum in pdfplumber-core
- Added validate() method to PdfBackend trait with default implementation
- Implemented LopdfBackend::validate() with checks for: missing /Type, missing /Pages, broken object references, invalid page tree, missing fonts in content streams
- Added Pdf::validate() public API facade method
- Added `pdfplumber validate <FILE>` CLI subcommand with --format json/text and summary counts
- Files changed: validation.rs (new), lib.rs (core/facade), backend.rs, lopdf_backend.rs, pdf.rs, cli.rs, main.rs, validate_cmd.rs (new)
- Tests: 7 unit tests (core types), 6 integration tests (validation logic), 5 CLI integration tests, 4 CLI arg parsing tests
- Dependencies added: none
- **Learnings for future iterations:**
  - lopdf `Stream::decompressed_content()` can fail on some streams; use fallback to `stream.content.clone()` for robustness
  - lopdf `Document::catalog()` returns `Result<&Dictionary, Error>` not ObjectId; access catalog via `doc.trailer.get(b"Root")`
  - Content stream font parsing: split by whitespace and look for `/FontName number Tf` pattern (simple but effective for validation)
  - Clippy catches collapsible if-let matches — collapse `if let Ok(x) = ... { if let Pattern = x { ... } }` into single match
---

## 2026-02-28 - US-083: Best-effort PDF repair
- Implemented RepairOptions struct (rebuild_xref, fix_stream_lengths, remove_broken_objects) and RepairResult in pdfplumber-core
- Added repair() method to PdfBackend trait with default implementation
- Implemented LopdfBackend::repair() with: stream length fix (recalculate /Length), broken reference removal (replace with Null), xref rebuild (via lopdf save/load)
- Added Pdf::open_with_repair(bytes, options, repair_opts) -> Result<(Pdf, RepairResult)> public API
- Added --repair flag to all CLI subcommands (except Validate)
- Added open_pdf_maybe_repair() shared helper for CLI commands
- Files changed: repair.rs (new), lib.rs (core/facade), backend.rs, lopdf_backend.rs, pdf.rs, cli.rs, main.rs, shared.rs, all 12 cmd modules, repair_integration.rs (new)
- Tests: 7 unit tests (core types), 7 integration tests (repair logic), 4 CLI arg parsing tests
- Dependencies added: none
- **Learnings for future iterations:**
  - lopdf normalizes stream /Length during save/load cycle; to test missing /Length, remove it from dict after object creation, before saving
  - Rust 2024 edition: no explicit `ref mut` in implicitly-borrowing match patterns
  - lopdf xref rebuild happens automatically on save — no additional code needed for rebuild_xref option
  - Recursive Object tree walking needed for broken reference repair (Array, Dictionary, Stream all contain nested objects)
---
