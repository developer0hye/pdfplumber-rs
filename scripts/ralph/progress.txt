# Ralph Progress Log
Started: 2026년  3월  1일 일요일 14시 50분 09초 KST

## Codebase Patterns

### CJK Encoding in CID Fonts
- Type0/CID fonts with predefined CMap encodings (GBK-EUC-H, ETen-B5-H, 90ms-RKSJ-H, etc.) use variable-length byte sequences
- The encoding name is in the Type0 font's `/Encoding` entry (not the CIDFont descendant)
- Without a `/ToUnicode` CMap, Unicode mapping requires decoding via the encoding (e.g., GBK bytes → Unicode)
- `encoding_rs` crate handles all common CJK encodings efficiently
- The CachedFont in interpreter.rs stores `cjk_encoding: Option<&'static encoding_rs::Encoding>` for runtime encoding detection

### Font Loading Pipeline
- `load_font_if_needed()` in interpreter.rs caches font info per resource name
- For Type0 fonts: detects CJK encoding, extracts CID metrics, ToUnicode CMap
- For simple fonts: extracts FontMetrics, /Encoding, ToUnicode CMap
- Unicode resolution chain: ToUnicode CMap → FontEncoding → CJK encoding → char::from_u32

---

## 2026-03-01 - US-164-1
- **What was implemented**: CJK encoding support for predefined CMap encodings (GBK-EUC-H, Big5, Shift-JIS, EUC-KR)
- **Root cause**: SimSun font in pr-136-example.pdf uses GBK-EUC-H encoding (not Identity-H). No ToUnicode CMap. The parser treated all CID font bytes as 2-byte pairs (Identity-H style) and used char::from_u32() for Unicode, producing wrong characters for GBK code points.
- **Files changed**:
  - `crates/pdfplumber-parse/Cargo.toml` — added `encoding_rs` dependency
  - `crates/pdfplumber-parse/src/cjk_encoding.rs` — new module for CJK encoding detection and byte decoding
  - `crates/pdfplumber-parse/src/interpreter.rs` — CJK-aware byte decoding and Unicode fallback
  - `crates/pdfplumber-parse/src/lib.rs` — registered new module
  - `crates/pdfplumber/tests/cross_validation.rs` — enabled pr-136 test
- **Dependencies added**: `encoding_rs = "0.8"` (standard Rust character encoding library)
- **Result**: pr-136-example.pdf extracts 5182 chars (exact match with Python pdfplumber)
- **Learnings for future iterations:**
  - GBK-EUC-H is a variable-length encoding: 0x00-0x80 single byte, 0x81-0xFE lead byte of 2-byte sequence
  - The cross-validation char match rate (17.6%) is low due to coordinate differences (~2.7pt in top), not text extraction issues
  - Font name differences: our parser uses Type0 BaseFont (e.g., "SimSun-GBK-EUC-H") while Python pdfplumber uses CIDFont descendant BaseFont ("SimSun")
---
