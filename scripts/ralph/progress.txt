# Ralph Progress Log
Started: 2026년  2월 28일 토요일 18시 13분 54초 KST

## Codebase Patterns
- **PyO3 module name conflict**: The pymodule function name `pdfplumber` conflicts with the external crate name `pdfplumber`. Use `::pdfplumber` to reference the external crate in imports.
- **lopdf dictionary macro**: In Rust 2024 edition, `lopdf::dictionary!` macro requires explicit import: `use lopdf::dictionary;`
- **Test PDFs**: Create minimal PDFs programmatically using `lopdf::Document::with_version("1.7")` + manual page tree construction. See `crates/pdfplumber-py/src/lib.rs` tests for pattern.
- **AcroForm field tree**: Form fields live in `/AcroForm` dictionary (document catalog), not in page `/Annots`. Walk `/Fields` array recursively via `/Kids`. Field type `/FT` can be inherited from parent nodes. Terminal fields have no `/Kids` with `/T` entries.
- **Form field page association**: Use `/P` reference in field dictionary to map fields to pages. Not all fields have `/P`, so `page_index` is `Option<usize>`.
- **Workspace member addition**: Add new crates to root `Cargo.toml` `[workspace] members` array.
- **Crate lib naming**: When lib name differs from package name (e.g., `name = "pdfplumber"` in pdfplumber-py), use `[lib] name = "pdfplumber"` in Cargo.toml.
- **PyO3 extension-module feature**: Must be a Cargo feature flag, NOT a direct pyo3 dependency feature. Direct use prevents test linking. Use `features = ["extension-module"]` in `[features]` and activate via maturin's `pyproject.toml`.
- **PyO3 test setup**: Add `pyo3 = { version = "0.24", features = ["auto-initialize"] }` in `[dev-dependencies]` and add `"rlib"` to `crate-type` for test linking. Set `doctest = false` to avoid rlib name collision with the `pdfplumber` crate.
- **Rust→Python dict conversion**: Use `PyDict::new(py)` + `set_item()` for converting Rust structs to Python dicts. For `Option<T>`, use `py.None()` for the None case.
- **wasm-bindgen non-wasm targets**: `JsError::new()` panics on non-wasm targets ("cannot call wasm-bindgen imported functions"). Test error paths via underlying Rust API instead of through wasm-bindgen wrappers.
- **wasm-bindgen crate setup**: Use `crate-type = ["cdylib", "rlib"]` (cdylib for wasm-pack output, rlib for tests). Set `doctest = false` to avoid issues.
- **serde_wasm_bindgen**: Use `serde_wasm_bindgen::to_value()` for complex Rust→JsValue conversion. Enable `serde` feature on the pdfplumber dependency.
- **WASM pdfplumber dependency**: Use `default-features = false, features = ["serde"]` to disable filesystem APIs (`open_file`) and enable serialization.

---

## 2026-02-28 - US-073
- What was implemented: PyO3 crate scaffolding for Python bindings
- Files changed:
  - `Cargo.toml` (workspace root) — added `crates/pdfplumber-py` to members
  - `crates/pdfplumber-py/Cargo.toml` — new crate with pyo3 + pdfplumber deps
  - `crates/pdfplumber-py/pyproject.toml` — maturin build backend
  - `crates/pdfplumber-py/src/lib.rs` — PyPdf (open/open_bytes/pages) + PyPage (page_number/width/height) + 4 Rust tests
- Dependencies added: `pyo3 0.24` (with extension-module feature), `lopdf 0.34` (dev-dependency for test PDF generation)
- **Learnings for future iterations:**
  - PyO3 0.24 pymodule signature: `fn name(m: &Bound<'_, PyModule>) -> PyResult<()>`
  - `crate-type = ["cdylib"]` is required for Python extension modules
  - Tests can verify the wrapper logic without the Python interpreter by testing inner field access directly
---

## 2026-02-28 - US-074
- What was implemented: Full Python API exposure for pdfplumber-rs
- Files changed:
  - `crates/pdfplumber-py/Cargo.toml` — added `rlib` crate-type, `auto-initialize` dev-dep, `extension-module` feature flag, `doctest = false`
  - `crates/pdfplumber-py/pyproject.toml` — updated to use `extension-module` feature
  - `crates/pdfplumber-py/src/lib.rs` — expanded from 165 to 1340+ lines:
    - PyPage: chars(), extract_text(), extract_words(), find_tables(), extract_tables(), lines(), rects(), curves(), images(), search(), crop(), within_bbox(), outside_bbox()
    - PyPdf: metadata getter, bookmarks() method
    - PyTable class: bbox, rows, accuracy, extract()
    - PyCroppedPage class: full content access + spatial filtering
    - 7 custom Python exception types (PdfParseError, PdfIoError, PdfFontError, PdfInterpreterError, PdfResourceLimitError, PdfPasswordRequired, PdfInvalidPassword)
    - 10 conversion helpers (char_to_dict, word_to_dict, line_to_dict, etc.)
    - 42 Rust unit tests
- Dependencies added: None (reused existing pyo3 0.24)
- **Learnings for future iterations:**
  - `extension-module` must be conditional — unconditional use prevents test linking to libpython
  - `DYLD_LIBRARY_PATH` may be needed for local test runs on macOS
  - `create_exception!` macro creates Python exception types that can be registered with `m.add()`
  - All Rust types can be converted to Python dicts via PyDict; complex nested types work well
---

## 2026-02-28 - US-075
- What was implemented: PyPI packaging for pdfplumber-py
- Files changed:
  - `crates/pdfplumber-py/pyproject.toml` — added full PyPI metadata: description, license, classifiers, authors, keywords, project URLs, readme
  - `crates/pdfplumber-py/src/lib.rs` — added `VERSION` constant (`env!("CARGO_PKG_VERSION")`), `__version__` module attribute, 7 new tests for packaging
  - `crates/pdfplumber-py/pdfplumber.pyi` — new Python type stubs for all classes (PDF, Page, Table, CroppedPage), exception types, and type aliases
  - `crates/pdfplumber-py/README.md` — new PyPI README with installation, quick start, API reference, comparison table, performance notes
- Dependencies added: None
- **Learnings for future iterations:**
  - `env!("CARGO_PKG_VERSION")` provides compile-time version from Cargo.toml
  - maturin auto-detects `.pyi` files in the crate directory and includes them in the wheel
  - `dynamic = ["version"]` in pyproject.toml makes maturin read version from Cargo.toml
  - `readme = "README.md"` in pyproject.toml includes the README in the PyPI listing
  - Tests can verify packaging artifacts (file existence, content assertions) using `env!("CARGO_MANIFEST_DIR")`
---

## 2026-02-28 - US-076
- What was implemented: WASM/JS bindings via wasm-bindgen
- Files changed:
  - `Cargo.toml` (workspace root) — added `crates/pdfplumber-wasm` to members
  - `crates/pdfplumber-wasm/Cargo.toml` — new crate with wasm-bindgen, serde-wasm-bindgen, pdfplumber (serde feature)
  - `crates/pdfplumber-wasm/src/lib.rs` — WasmPdf (open/pageCount/page/metadata) + WasmPage (pageNumber/width/height/chars/extractText/extractWords/findTables/extractTables/search) + 18 Rust tests
  - `crates/pdfplumber-wasm/tests/test.mjs` — JavaScript test script for manual verification
- Dependencies added: `wasm-bindgen 0.2`, `serde-wasm-bindgen 0.6`, `wasm-bindgen-test 0.3` (dev-dep)
- **Learnings for future iterations:**
  - `JsError::new()` panics on non-wasm targets — error path tests must use underlying Rust API
  - `serde_wasm_bindgen::to_value()` also panics on non-wasm — test JsValue methods only in wasm-bindgen-test
  - wasm-pack auto-generates TypeScript `.d.ts` files with proper types
  - Static methods in `#[wasm_bindgen] impl` blocks (no `&self`) become JS static class methods
  - `#[wasm_bindgen(getter, js_name = "camelCase")]` for JS-idiomatic property names
  - Rust 2024 edition: `ref mut` not allowed in implicitly-borrowing patterns (lopdf dictionary matching)
- **npm packaging pattern**: wasm-pack auto-generates `package.json`, `.d.ts`, and `.js` in `pkg/` from Cargo.toml metadata. Create hand-crafted `.d.ts` with richer types alongside the crate for IDE consumers. wasm-pack also copies `README.md` from crate root into `pkg/`.
---

## 2026-02-28 - US-077
- What was implemented: npm packaging for pdfplumber-wasm
- Files changed:
  - `crates/pdfplumber-wasm/pdfplumber-wasm.d.ts` — new hand-crafted TypeScript type definitions with rich interfaces (PdfChar, PdfWord, PdfTable, PdfSearchMatch, PdfMetadata, WasmPdf, WasmPage)
  - `crates/pdfplumber-wasm/README.md` — new npm README with installation, browser/Node.js/bundler usage, API reference, comparison table
  - `crates/pdfplumber-wasm/examples/browser-demo.html` — new browser demo with drag-and-drop PDF loading, text/word/table extraction
  - `crates/pdfplumber-wasm/src/lib.rs` — added 10 packaging artifact tests
- Dependencies added: None
- **Learnings for future iterations:**
  - wasm-pack `--target bundler` generates `module` field in package.json (ES module), `--target nodejs` generates `main` (CommonJS)
  - wasm-pack copies README.md from crate root into the `pkg/` output directory
  - Hand-crafted `.d.ts` with proper interfaces is valuable since auto-generated types use `any` for `JsValue` returns
  - The `pkg/` directory is gitignored (has `*` in `.gitignore`) — source artifacts go in the crate root
  - File existence tests using `env!("CARGO_MANIFEST_DIR")` are reliable for verifying packaging artifacts
---

## 2026-02-28 - US-078
- What was implemented: Markdown output format for PDF page content
- Files changed:
  - `crates/pdfplumber-core/src/markdown.rs` — new module: MarkdownRenderer, MarkdownOptions, heading detection (font size heuristics), paragraph grouping, GFM table conversion, list detection (bullet/numbered), bold/italic emphasis from font names
  - `crates/pdfplumber-core/src/lib.rs` — registered markdown module, exported MarkdownRenderer and MarkdownOptions
  - `crates/pdfplumber/src/lib.rs` — re-exported MarkdownRenderer and MarkdownOptions
  - `crates/pdfplumber/src/page.rs` — added `Page::to_markdown(options)` method
  - `crates/pdfplumber-cli/src/cli.rs` — added `Markdown` variant to `TextFormat` enum
  - `crates/pdfplumber-cli/src/text_cmd.rs` — added `--format markdown` handling using `page.to_markdown()`
  - `crates/pdfplumber-cli/src/bookmarks_cmd.rs` — handle Markdown variant (fallback to Text)
  - `crates/pdfplumber-cli/src/info_cmd.rs` — handle Markdown variant (fallback to Text)
- Dependencies added: None
- **Learnings for future iterations:**
  - Heading detection uses font size ratio relative to median: H1 >= 2.0x, H2 >= 1.6x, H3 >= 1.3x, H4 >= 1.2x
  - GFM table: first row is header, separator row with `---`, pipe characters escaped with `\|`, newlines in cells replaced with spaces
  - List detection: supports `- `, `* `, `• `, `– `, `— ` bullets and `N. ` / `N) ` numbered patterns
  - Bold/italic detection: font name analysis (contains "Bold"/"Heavy"/"Black" or "Italic"/"Oblique")
  - Clippy: prefer `strip_prefix()` over `starts_with()` + manual slicing; use function references instead of closures
  - When adding variants to shared enums (like TextFormat), must handle exhaustive matches in ALL commands that use them
  - `split_lines_at_columns` uses `x_density` threshold — test character gaps must be smaller than `x_density` to stay in same line
---

## 2026-02-28 - US-079
- What was implemented: HTML output format for PDF page content
- Files changed:
  - `crates/pdfplumber-core/src/html.rs` — new module: HtmlRenderer, HtmlOptions, heading detection, paragraph wrapping (`<p>`), HTML table conversion (`<table>/<thead>/<tbody>/<tr>/<th>/<td>`), list detection (`<ul>`/`<ol>`/`<li>`), bold/italic emphasis (`<strong>`/`<em>`), HTML escaping
  - `crates/pdfplumber-core/src/lib.rs` — registered html module, exported HtmlRenderer and HtmlOptions
  - `crates/pdfplumber/src/lib.rs` — re-exported HtmlRenderer and HtmlOptions
  - `crates/pdfplumber/src/page.rs` — added `Page::to_html(options)` method
  - `crates/pdfplumber-cli/src/cli.rs` — added `Html` variant to `TextFormat` enum
  - `crates/pdfplumber-cli/src/text_cmd.rs` — added `--format html` handling using `page.to_html()`
  - `crates/pdfplumber-cli/src/bookmarks_cmd.rs` — handle Html variant (fallback to Text)
  - `crates/pdfplumber-cli/src/info_cmd.rs` — handle Html variant (fallback to Text)
- Dependencies added: None
- **Learnings for future iterations:**
  - HTML renderer follows same architecture as Markdown renderer: classify_blocks → render_elements
  - HTML escaping (`&amp;`, `&lt;`, `&gt;`, `&quot;`) is essential for all user-facing text in HTML output
  - List grouping: consecutive ListItem elements of the same type (ordered/unordered) are grouped into `<ul>`/`<ol>` wrapper
  - Table HTML uses `<thead>` for first row and `<tbody>` for remaining rows, mirroring common HTML table semantics
  - When adding variants to shared enums (like TextFormat), must handle exhaustive matches in ALL commands (bookmarks_cmd, info_cmd, text_cmd)
---

## 2026-02-28 - US-080
- What was implemented: Form field extraction (AcroForms) from PDF documents
- Files changed:
  - `crates/pdfplumber-core/src/form_field.rs` — new module: FormField struct, FieldType enum (Text/Button/Choice/Signature), Display impl, from_pdf_name/as_pdf_name methods, 14 unit tests
  - `crates/pdfplumber-core/src/lib.rs` — registered form_field module, exported FormField and FieldType
  - `crates/pdfplumber-parse/src/backend.rs` — added `document_form_fields()` to PdfBackend trait + mock impl
  - `crates/pdfplumber-parse/src/lopdf_backend.rs` — implemented AcroForm extraction: `extract_document_form_fields()`, `walk_field_tree()`, `extract_field_value()`, `decode_pdf_string()`, `extract_field_bbox()`, `extract_field_options()`, `resolve_field_page()`, 9 integration tests
  - `crates/pdfplumber/src/lib.rs` — re-exported FormField and FieldType
  - `crates/pdfplumber/src/pdf.rs` — added `Pdf::form_fields()` method, page-level field filtering in `page()`
  - `crates/pdfplumber/src/page.rs` — added `form_fields` field to Page struct, `form_fields()` accessor, updated all constructors
  - `crates/pdfplumber-cli/src/forms_cmd.rs` — new CLI subcommand: text/json/csv output for form fields
  - `crates/pdfplumber-cli/src/cli.rs` — added `Forms` variant to Commands enum, 6 CLI parsing tests
  - `crates/pdfplumber-cli/src/main.rs` — registered forms_cmd module and handler
- Dependencies added: None
- **Learnings for future iterations:**
  - AcroForm fields are document-level (in catalog), not page-level — filter by `/P` reference for per-page access
  - Field tree is hierarchical: `/Kids` with `/T` entries are child fields, `/Kids` without `/T` are widget annotations
  - Field type `/FT` can be inherited from parent nodes in the tree
  - `/V` can be String, Name, or Array depending on field type — handle all variants
  - `/Opt` for choice fields can contain simple strings or `[export_value, display_value]` pairs
  - `decode_pdf_string` handles UTF-16 BE BOM (0xFE 0xFF) for internationalized field values
  - pdfplumber-py test failure (libpython3.11.dylib not found) is pre-existing and unrelated to code changes
---

## 2026-02-28 - US-081
- What was implemented: Structure tree / tagged PDF access
- Files changed:
  - `crates/pdfplumber-core/src/struct_tree.rs` — new module: StructElement struct (element_type, mcids, alt_text, actual_text, lang, bbox, children, page_index), 8 unit tests
  - `crates/pdfplumber-core/src/text.rs` — added `mcid: Option<u32>` and `tag: Option<String>` fields to Char struct
  - `crates/pdfplumber-core/src/lib.rs` — registered struct_tree module, exported StructElement
  - `crates/pdfplumber-parse/src/backend.rs` — added `document_structure_tree()` to PdfBackend trait + mock impl
  - `crates/pdfplumber-parse/src/lopdf_backend.rs` — implemented structure tree extraction: `extract_document_structure_tree()`, `parse_struct_kids()`, `parse_struct_element()`, `collect_mcids_and_children()`, `process_k_dict()`, `resolve_struct_page()`, `extract_string_entry()`, `resolve_object()`, 8 integration tests
  - `crates/pdfplumber/src/lib.rs` — re-exported StructElement
  - `crates/pdfplumber/src/pdf.rs` — added structure tree extraction in `Pdf::page()`, `filter_struct_elements_for_page()` helper
  - `crates/pdfplumber/src/page.rs` — added `structure_tree` field to Page struct, `structure_tree()` accessor, updated all constructors
  - `crates/pdfplumber-parse/src/char_extraction.rs` — added `mcid: None, tag: None` to Char construction
  - 14 other files — mechanical `mcid: None, tag: None` additions to Char construction sites
- Dependencies added: None
- **Learnings for future iterations:**
  - Structure tree lives in `/StructTreeRoot` in document catalog, similar to `/AcroForm` for form fields
  - `/K` entries can be: integer (MCID), dictionary (MCR or child element), reference, or array of mixed
  - MCR dictionaries have `/Type /MCR` and `/MCID` keys — differentiate from child struct elements via `/S` key
  - `/Pg` reference in struct elements maps to page index for per-page filtering
  - `resolve_object()` helper needed for following indirect references in structure tree
  - Adding fields to Char struct requires updating 22+ construction sites across ~14 files
  - Use `replace_all` mode in Edit tool for efficient updates when pattern appears multiple times in a file
---
