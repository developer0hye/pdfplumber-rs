## Codebase Patterns

- **PdfBackend trait pattern**: Document-level features add a method to `PdfBackend` trait, implement in `LopdfBackend`, cache result in `Pdf` struct on open, expose via accessor method.
- **Test PDF creation**: Use `lopdf::Document::with_version("1.5")` and `doc.add_object()` to build test PDFs programmatically. Set trailer entries for document-level features.
- **String extraction from lopdf**: Use `Object::String(bytes, _)` matching. Handle UTF-16 BE (BOM 0xFE 0xFF) and Latin-1/UTF-8 fallback. Resolve indirect references before reading.
- **CLI info output**: Text format prints sections with println!, JSON format builds serde_json::Value and prints pretty. New document-level data goes in both formats.
- **Page box pattern**: Page-level optional boxes (TrimBox/BleedBox/ArtBox) follow: add trait method → implement in LopdfBackend with `resolve_inherited()` → add field + accessor to Page → wire up in `Pdf::page()`. Optional boxes use `Option<BBox>`, always-present boxes use `BBox`.
- **Annotation pattern**: Page-level annotations follow: add trait method `page_annotations()` → implement in LopdfBackend parsing /Annots array → add `Vec<Annotation>` field to Page → pass through `from_extraction()`. Each annotation entry may be a direct dict or indirect ref. Extract /Subtype, /Rect, /Contents, /T (author), /M (date).
- **CLI box display**: MediaBox always shown; optional boxes only shown when present. JSON uses conditional insertion (`page_json["key"] = val`). Text uses `if let Some(ref b) = ...`.
- **Hyperlink pattern**: Hyperlinks follow: add `page_hyperlinks()` trait method → implement in LopdfBackend filtering for Link annotations and resolving /A (URI, GoTo) or /Dest → add `Vec<Hyperlink>` field to Page → pass through `from_extraction()`. Skip links without resolvable URIs.
- **CLI subcommand pattern**: New CLI commands: add variant to `Commands` enum in cli.rs → create `<name>_cmd.rs` with `run()`, `write_text()`, `write_json()`, `write_csv()` → wire up in main.rs match. Each output format follows the same structure (header + per-page iteration).
- **Bookmark/outline pattern**: Document-level outlines follow: add `document_bookmarks()` to PdfBackend trait → implement in LopdfBackend walking outline tree via /First, /Next sibling links → cache in Pdf struct on open → expose via `Pdf::bookmarks()`. Resolve destinations using `doc.get_pages()` (1-indexed page map). Handle circular references with visited set + max depth limit.
- **Search pattern**: Text search follows: add types (SearchMatch, SearchOptions) + algorithm (search_chars) in pdfplumber-core/search.rs → add Page::search() delegating to search_chars → add Pdf::search_all() iterating pages. Algorithm: concatenate char texts, map byte offsets→char indices, run regex, compute union bbox from matched chars.
- **Dedupe pattern**: Character deduplication follows: add DedupeOptions struct + dedupe_chars() algorithm in pdfplumber-core/dedupe.rs → add Page::dedupe_chars() and CroppedPage::dedupe_chars() returning CroppedPage with filtered chars. Algorithm: iterate chars, check each against kept list (same text, positions within tolerance, extra_attrs match), keep first occurrence. Uses from_page_data() helper to build CroppedPage without coordinate adjustment.
- **ExtractOptions pattern**: Document-level extraction settings go in ExtractOptions (set at Pdf::open() time, used during Pdf::page()). For text processing options (normalization, etc.), add field to ExtractOptions, apply in Pdf::page() after char creation. CLI: add separate clap ValueEnum arg type with conversion method, use open_pdf_with_norm() helper.
- **Filter pattern**: Custom filtering follows: add PageObject enum in pdfplumber-core/page_object.rs → add Page::filter() and CroppedPage::filter() accepting Fn(&PageObject) -> bool → return CroppedPage with filtered objects (no coordinate adjustment). FilteredPage is a type alias for CroppedPage. Uses from_page_data() for Page, direct struct construction for CroppedPage.
- **SVG overlay pattern**: SvgRenderer is a builder: `new(w,h)` → `draw_chars/rects/lines/edges/tables/intersections/cells(&mut self, items, &DrawStyle)` → `to_svg(&SvgOptions) -> String`. DrawStyle has `fill`, `stroke`, `stroke_width`, `opacity` with per-object-type defaults. Elements accumulate in `Vec<String>` and render between page boundary and `</svg>`. No external SVG library needed.
- **Debug pipeline pattern**: For exposing intermediate pipeline results, add a `*_debug()` method returning a struct with all stages. `TableFinder::find_tables_debug()` returns `TableFinderDebug { edges, intersections, cells, tables }`. `Page::debug_tablefinder_svg()` runs the pipeline and renders each stage with distinct styles via `SvgDebugOptions` toggle flags.

# Ralph Progress Log
Started: 2026년  2월 28일 토요일 15시 35분 07초 KST
---

# Ralph Progress Log - Phase 7: Differentiation - Visual Debugging (SVG), Table Quality, Image Content, Encryption
Started: 2026년  2월 28일 토요일 17시 04분 35초 KST
---

## 2026-02-28 - US-067 - Visual debugging - SVG page rendering foundation
- Implemented `SvgRenderer` struct and `SvgOptions` in `pdfplumber-core/src/svg.rs`
- Added `Page::to_svg(options)` convenience method in `pdfplumber/src/page.rs`
- Re-exported `SvgRenderer` and `SvgOptions` from facade crate
- Files changed: `crates/pdfplumber-core/src/svg.rs` (new), `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/lib.rs`, `crates/pdfplumber/src/page.rs`
- Dependencies added: none (pure string generation)
- **Learnings for future iterations:**
  - BBox fields (`x0`, `top`, `x1`, `bottom`) are public fields, not methods. `width()` and `height()` are methods.
  - The `#![deny(missing_docs)]` lint is active on both `pdfplumber-core` and `pdfplumber` crates — all public items need doc comments.
  - SVG pattern: `SvgRenderer::new(width, height)` → `renderer.to_svg(&SvgOptions)` → String. No external SVG library needed.
---

## 2026-02-28 - US-068 - Visual debugging - object overlay drawing
- Added `DrawStyle` struct with `fill`, `stroke`, `stroke_width`, `opacity` fields and default style constructors (`chars_default`, `lines_default`, `rects_default`, `edges_default`, `tables_default`)
- Added `draw_chars()`, `draw_rects()`, `draw_lines()`, `draw_edges()`, `draw_tables()` methods to `SvgRenderer` (accumulates SVG elements rendered by `to_svg()`)
- Added `pdfplumber debug <FILE> --output <file.svg>` CLI subcommand that generates SVG with all extracted objects overlaid
- Multi-page support: appends `_pageN` to output filename when multiple pages specified
- Files changed: `crates/pdfplumber-core/src/svg.rs`, `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/lib.rs`, `crates/pdfplumber-cli/src/cli.rs`, `crates/pdfplumber-cli/src/main.rs`, `crates/pdfplumber-cli/src/debug_cmd.rs` (new)
- Dependencies added: none
- **Learnings for future iterations:**
  - SvgRenderer uses builder pattern: accumulate elements via `draw_*` methods, then `to_svg()` renders header + page boundary + accumulated elements + close.
  - `DrawStyle::to_svg_style()` generates inline CSS `style` attribute. Opacity=1.0 is omitted for cleaner SVG.
  - CLI debug subcommand doesn't need output format variants (text/json/csv) — it only outputs SVG files.
---

## 2026-02-28 - US-069 - Visual debugging - debug_tablefinder SVG
- Added `TableFinderDebug` struct in `pdfplumber-core/src/table.rs` holding intermediate pipeline results (edges, intersections, cells, tables)
- Added `TableFinder::find_tables_debug()` method that returns `TableFinderDebug` with all pipeline stages
- Added `SvgDebugOptions` struct in `pdfplumber-core/src/svg.rs` with `show_edges`, `show_intersections`, `show_cells`, `show_tables` flags (all default true)
- Added `DrawStyle::intersections_default()` (red filled) and `DrawStyle::cells_default()` (magenta dashed)
- Added `SvgRenderer::draw_intersections()` for circle elements and `SvgRenderer::draw_cells()` for dashed rect elements
- Added `Page::debug_tablefinder_svg(settings, options)` in `pdfplumber/src/page.rs`
- Added `--tables` flag to `pdfplumber debug` CLI subcommand
- Re-exported `SvgDebugOptions` and `TableFinderDebug` from facade crate
- Files changed: `crates/pdfplumber-core/src/svg.rs`, `crates/pdfplumber-core/src/table.rs`, `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/page.rs`, `crates/pdfplumber/src/lib.rs`, `crates/pdfplumber-cli/src/cli.rs`, `crates/pdfplumber-cli/src/debug_cmd.rs`, `crates/pdfplumber-cli/src/main.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - `find_tables_debug()` duplicates the pipeline logic from `find_tables()` to capture intermediates. Consider refactoring to shared internal pipeline if more debug methods are needed.
  - SVG `stroke-dasharray` attribute goes directly on the element, not inside the `style` attribute.
  - `Intersection` type from `table.rs` is used in `svg.rs` — import at module level so `use super::*` in tests brings it in.
  - The Explicit strategy in `find_tables_debug()` must inline-build edges (not use `explicit_lines_to_edges()`) because it mixes detected + explicit edge bounds.
---

## 2026-02-28 - US-070 - Table extraction quality metrics
- Added `TableQuality` struct with `accuracy` and `whitespace` fields in `pdfplumber-core/src/table.rs`
- Added `Table::accuracy()` — percentage of cells with non-empty text (0.0 to 1.0). Whitespace-only cells treated as empty.
- Added `Table::whitespace()` — average ratio of whitespace chars in cell text (0.0 to 1.0). Only considers cells with text.
- Added `Table::quality()` — returns combined `TableQuality` struct
- Added `TableSettings::min_accuracy` field (Option<f64>) for auto-filtering low-quality tables in `Page::find_tables()`
- Added quality metrics (`accuracy`, `whitespace`) to CLI `tables` JSON output
- Re-exported `TableQuality` from facade crate
- Files changed: `crates/pdfplumber-core/src/table.rs`, `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/lib.rs`, `crates/pdfplumber/src/page.rs`, `crates/pdfplumber-cli/src/tables_cmd.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - Cell text is `Option<String>` — `None` means no text, `Some("")` shouldn't normally occur but whitespace-only strings should be treated as empty for accuracy.
  - Quality metrics are computed from `table.cells` (flat list), not from `rows` or `columns` (which contain the same cells organized differently).
  - `min_accuracy` filtering must happen after `extract_text_for_cells()` since accuracy depends on cell text.
---
