# Ralph Progress Log
Started: 2026년  2월 28일 토요일 09시 18분 01초 KST

## Codebase Patterns
- New modules go in `crates/pdfplumber-core/src/` with `pub mod` in `lib.rs` and re-exports at crate root
- Facade crate (`crates/pdfplumber/src/lib.rs`) re-exports all public types from pdfplumber-core
- Tests use inline `#[cfg(test)] mod tests` with `assert_approx` for f64 comparisons (tolerance 1e-6)
- Helper constructors: `make_line()`, `make_rect()`, `make_curve()` in test modules
- Coordinate system: top-left origin (x0, top, x1, bottom) where top < bottom
- `BBox::union()` computes enclosing bbox of two bboxes
- `Edge` struct has x0/top/x1/bottom/orientation/source fields
- `derive_edges()` converts Lines+Rects+Curves to Vec<Edge>
- Clippy: use `#[derive(Default)]` with `#[default]` variant instead of manual `impl Default` for enums
- `snap_edges()` function lives in `table.rs` as a public standalone function; uses `snap_group()` helper for clustering
- Edge processing helpers: `make_h_edge(x0, y, x1)` and `make_v_edge(x, top, bottom)` in test module for concise test construction
- `edges_to_intersections(edges, x_tolerance, y_tolerance)` takes `&[Edge]` and returns `Vec<Intersection>`
- `Intersection` struct has `x: f64` and `y: f64` fields
- Intersection detection: checks H-edge y within V-edge y-span and V-edge x within H-edge x-span (with tolerance)
- Deduplication: intersections at the same point (within 1e-9) are deduplicated via sort+dedup_by
- `intersections_to_cells(intersections: &[Intersection]) -> Vec<Cell>` constructs cells from a grid of intersection points
- Cell construction: collects unique x/y coords, sorts them, checks all 4 corners for each adjacent pair
- `cells_to_tables(cells: Vec<Cell>) -> Vec<Table>` groups adjacent cells into tables using union-find
- Table grouping: `cells_share_edge()` checks shared boundaries, `float_key()` converts f64→i64 for BTreeMap grouping
- `edge_length(edge)` computes length via Euclidean distance (sqrt(dx²+dy²))
- `TableFinder::find_tables()` runs full pipeline: filter by strategy → filter by min_length → snap → join → intersections → cells → tables
- LatticeStrict filters edges by `EdgeSource::Line` only; Lattice uses all edge sources
- `extract_text_for_cells(cells, chars)` populates cell text using center-point containment + WordExtractor
- Center-point containment: char bbox center (cx, cy) must fall within cell bbox
- Text assembly: chars → WordExtractor → group words into lines by y-tolerance → join with spaces/newlines
- `words_to_edges_stream(words, text_x_tol, text_y_tol, min_words_v, min_words_h)` generates synthetic edges from word alignment
- Stream strategy: cluster words by x0/x1 (vertical edges) and top/bottom (horizontal edges), filter by min_words threshold
- `TableFinder::new_with_words(edges, words, settings)` constructor for Stream strategy; `new()` still works with empty words
- `explicit_lines_to_edges(explicit: &ExplicitLines) -> Vec<Edge>` converts coordinate lists to edges with `EdgeSource::Explicit`
- Explicit strategy mixing: `find_tables()` computes bounding range from detected edges + explicit coordinates for edge span computation
- `Page::find_tables(settings)` → Vec<Table> with populated cell text; uses TableFinder internally
- `Page::extract_tables(settings)` → Vec<Vec<Vec<Option<String>>>> (tables→rows→cells as text)
- `Page::extract_table(settings)` → Option<Vec<Vec<Option<String>>>> (largest table by cell count)

---

## 2026-02-28 - US-029
- Implemented TableSettings, Strategy, TableFinder, Table, Cell, ExplicitLines
- Files changed: `crates/pdfplumber-core/src/table.rs` (new), `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/lib.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - All table detection types live in `crates/pdfplumber-core/src/table.rs`
  - Strategy defaults to Lattice, all tolerances default to 3.0
  - TableFinder::find_tables() is a placeholder returning empty Vec, will be wired up in US-030 through US-036
  - Clippy enforces `#[derive(Default)]` for enums on Rust edition 2024
---

## 2026-02-28 - US-030
- Implemented `snap_edges()` for parallel edge alignment and `snap_group()` clustering helper
- Files changed: `crates/pdfplumber-core/src/table.rs`, `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/lib.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - `snap_edges(edges, snap_x_tolerance, snap_y_tolerance)` takes owned Vec<Edge> and returns Vec<Edge>
  - Horizontal edges cluster by y-coord (top/bottom), vertical edges cluster by x-coord (x0/x1)
  - Clustering algorithm: sort by perpendicular axis, group consecutive within tolerance, replace with mean
  - Diagonal edges pass through unchanged
  - Snap only aligns positions, does NOT merge edges (merge is US-031 join_edge_group)
---

## 2026-02-28 - US-031
- Implemented `join_edge_group()` for merging overlapping/adjacent collinear edge segments
- Files changed: `crates/pdfplumber-core/src/table.rs`, `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/lib.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - `join_edge_group(edges, join_x_tolerance, join_y_tolerance)` takes owned Vec<Edge> and returns Vec<Edge>
  - Uses `join_collinear()` helper: groups by collinear key (y for horizontal, x for vertical), sorts by span start, merges when gap ≤ tolerance
  - Chain merging works naturally: sorted segments extend current span greedily
  - Diagonal edges pass through unchanged (consistent with snap_edges)
---

## 2026-02-28 - US-032
- Implemented `edges_to_intersections()` for finding intersection points between horizontal and vertical edges
- Added `Intersection` struct with x/y coordinates
- Files changed: `crates/pdfplumber-core/src/table.rs`, `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/lib.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - `edges_to_intersections(edges, x_tolerance, y_tolerance)` takes `&[Edge]` (borrows) unlike snap/join which take owned
  - Intersection detection checks that V-edge x is within H-edge x-span ± x_tolerance AND H-edge y is within V-edge y-span ± y_tolerance
  - Results are sorted by (x, y) and deduplicated for points at the same location (within 1e-9)
  - Diagonal edges are filtered out (only H×V crossings matter)
  - 13 tests covering: empty input, cross, T-intersection, L-corner, parallel (no intersection), tolerance-based, grid 2x2, diagonal ignored, multiple edges, separate x/y tolerance, deduplication
---

## 2026-02-28 - US-033
- Implemented `intersections_to_cells()` for constructing rectangular cells from intersection points
- Files changed: `crates/pdfplumber-core/src/table.rs`, `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/lib.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - `intersections_to_cells(intersections: &[Intersection]) -> Vec<Cell>` takes borrowed slice
  - Algorithm: collect unique x/y coords → sort → check all 4 corners for each adjacent (xi,xi+1)×(yi,yi+1) pair
  - Deduplication of coordinates uses 1e-9 tolerance (same as intersection dedup)
  - Missing corners are skipped gracefully (no panics)
  - All cells have `text: None` — text extraction is a separate step (US-036)
  - 10 tests covering: empty, 2x2 grid, 3x3 grid, missing corner, irregular grid, partial grid, single point, collinear points, 4x3 grid, text is None
---

## 2026-02-28 - US-034
- Implemented `cells_to_tables()` for grouping adjacent cells into distinct tables
- Added `cells_share_edge()` helper and `float_key()` utility for coordinate grouping
- Files changed: `crates/pdfplumber-core/src/table.rs`, `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/lib.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - `cells_to_tables(cells: Vec<Cell>) -> Vec<Table>` takes owned Vec, returns sorted Vec<Table>
  - Uses union-find algorithm to group cells sharing edges (vertical or horizontal boundary with overlapping ranges)
  - `cells_share_edge()` checks for shared vertical boundary (x1==x0 with overlapping y) or shared horizontal boundary (bottom==top with overlapping x)
  - Rows grouped by `float_key(top)` (multiply by 1000, round to i64) using BTreeMap for sorted order
  - Columns grouped by `float_key(x0)` similarly
  - Tables sorted by (top, x0) for deterministic output
  - 9 tests covering: empty, single cell, 2x2 grid, row ordering, column ordering, two separate tables, 3x3 grid, single row, single column
---

## 2026-02-28 - US-035
- Implemented full Lattice pipeline in `TableFinder::find_tables()`: filter by strategy → filter by min_length → snap → join → intersections → cells → tables
- Added `edge_length()` helper for computing edge length via Euclidean distance
- LatticeStrict mode filters to `EdgeSource::Line` only (excludes rect edges)
- Lattice mode uses all edge sources including rect edges
- Files changed: `crates/pdfplumber-core/src/table.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - Pipeline is straightforward chaining of existing functions: snap_edges → join_edge_group → edges_to_intersections → intersections_to_cells → cells_to_tables
  - Edge source filtering for LatticeStrict uses the `EdgeSource` enum discriminant
  - `edge_length()` uses Euclidean distance which works for all orientations (H, V, diagonal)
  - 10 tests covering: simple bordered table, rect edges, strict mode, strict with lines, edge min length filtering, full pipeline snap+join, empty edges, no intersections, strict mixed edges
---

## 2026-02-28 - US-036
- Implemented `extract_text_for_cells()` for extracting text content within detected table cells
- Uses center-point containment: char bbox center (cx, cy) must be within cell bbox
- Groups chars into words via `WordExtractor`, then groups words into lines by y-proximity
- Joins words within a line with spaces, lines with newlines
- Cells with no matching chars get `text = None`
- Files changed: `crates/pdfplumber-core/src/table.rs`, `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/lib.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - `extract_text_for_cells(cells: &mut [Cell], chars: &[Char])` takes mutable slice to modify in place
  - Uses `WordOptions::default()` for word grouping (x_tolerance=3, y_tolerance=3)
  - Line grouping uses same y_tolerance as word grouping for consistency
  - 10 tests covering: single word, empty cell, chars outside, center-point containment (in/out), multiple words, multiple lines, two cells, no cells, mixed empty/populated
---

## 2026-02-28 - US-037
- Implemented Stream strategy for text-based synthetic edge table detection
- Added `words_to_edges_stream()` function that generates synthetic edges from word alignment patterns
- Added `cluster_words_to_edges()` helper for clustering words by coordinate and producing edges
- Added `EdgeSource::Stream` variant for synthetic stream edges
- Added `TableFinder::new_with_words()` constructor for providing words alongside edges
- Updated `TableFinder::find_tables()` to handle Stream strategy by generating synthetic edges from word positions
- Files changed: `crates/pdfplumber-core/src/table.rs`, `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/lib.rs`, `crates/pdfplumber-core/src/edges.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - `words_to_edges_stream(words, text_x_tolerance, text_y_tolerance, min_words_vertical, min_words_horizontal)` takes `&[Word]`
  - Vertical edges from x0 alignment (left edges) and x1 alignment (right edges) of words
  - Horizontal edges from top alignment and bottom alignment of words
  - Clustering: sort words by coordinate, group consecutive within tolerance, take mean position
  - Each synthetic edge spans the full extent of the aligned words in the perpendicular direction
  - `EdgeKind` internal enum used to specify whether to produce vertical or horizontal edges from clusters
  - `TableFinder` now has a `words: Vec<Word>` field, empty by default for backward compatibility
  - Stream strategy uses text_x_tolerance/text_y_tolerance for clustering (not snap_tolerance)
  - 13 tests covering: empty words, x0/x1 vertical alignment, top/bottom horizontal alignment, threshold filtering, tolerance grouping, no grouping beyond tolerance, full pipeline, no words, edge source, min_words_horizontal default
---

## 2026-02-28 - US-038
- Implemented Explicit strategy for user-provided line coordinates
- Added `EdgeSource::Explicit` variant to edges.rs
- Added `explicit_lines_to_edges()` standalone function that converts ExplicitLines (h/v coordinate lists) to Edge objects
- Updated `TableFinder::find_tables()` with Explicit strategy handling including mixing support
- Mixing: explicit edges are combined with detected edges, spans computed from both sources
- Files changed: `crates/pdfplumber-core/src/table.rs`, `crates/pdfplumber-core/src/edges.rs`, `crates/pdfplumber-core/src/lib.rs`, `crates/pdfplumber/src/lib.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - `explicit_lines_to_edges(explicit: &ExplicitLines) -> Vec<Edge>` is a standalone function for pure explicit grids
  - Horizontal edges span from min(vertical_lines) to max(vertical_lines); verticals span from min(horizontal_lines) to max(horizontal_lines)
  - Returns empty Vec if either list is empty (can't form a grid without both)
  - Mixing in `find_tables()`: computes bounding range from both detected edges AND explicit coordinates, so explicit horizontal lines span the full x-range including detected edges
  - All explicit edges have `EdgeSource::Explicit` for tracking provenance
  - 13 tests covering: basic conversion, empty lists (h/v/both), edge source, grid detection (3x3/2x2), no explicit_lines, mixing with detected edges, single line each, unsorted coordinates
---

## 2026-02-28 - US-039
- Implemented Page table API: `find_tables()`, `extract_tables()`, `extract_table()`
- `find_tables(&self, settings: &TableSettings) -> Vec<Table>` creates a TableFinder with page edges + words, runs pipeline, populates cell text
- `extract_tables(&self, settings: &TableSettings) -> Vec<Vec<Vec<Option<String>>>>` returns 2D text arrays
- `extract_table(&self, settings: &TableSettings) -> Option<Vec<Vec<Option<String>>>>` returns largest table by cell count (then area)
- Text extraction populates cells, rows, and columns separately via `extract_text_for_cells()`
- Files changed: `crates/pdfplumber/src/page.rs`, `scripts/ralph/prd.json`
- Dependencies added: none
- **Learnings for future iterations:**
  - Page methods import `TableFinder`, `TableSettings`, `Table`, `extract_text_for_cells` from pdfplumber-core
  - `TableFinder::new_with_words()` is used for all strategies (words are empty Vec for non-Stream strategies, no harm)
  - Text extraction must be called on `table.cells`, `table.rows[*]`, and `table.columns[*]` separately since they are independent copies
  - `extract_table()` picks the largest table: first by cell count, then by bbox area as tiebreaker
  - Test helpers `hline(x0, y, x1)` and `vline(x, top, bottom)` simplify line creation in tests
  - 16 tests covering: simple bordered table, cell text, 2x2 table, empty page, no lines, rects only, extract_tables simple/2x2/empty/empty-cells, extract_table largest/none, stream strategy, explicit strategy, multiple tables, lattice strict
---
