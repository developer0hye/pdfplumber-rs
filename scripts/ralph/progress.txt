## Codebase Patterns

- **Font handling architecture**: Fonts are cached in `CachedFont` struct in interpreter.rs. Simple fonts use `FontMetrics` (widths array indexed by char_code - first_char). CID fonts use `CidFontMetrics` (HashMap<u32, f64> for sparse widths + default_width).
- **CID font 2-byte char codes**: CID fonts use `show_string_cid()` which reads pairs of bytes as big-endian u16 character codes. Simple fonts use `show_string()` with single-byte codes. The `is_cid_font` flag on `CachedFont` controls dispatch.
- **Subset font prefix**: PDF subset fonts use `ABCDEF+RealName` pattern. `strip_subset_prefix()` removes the 6-uppercase-letter prefix. Applied to all font `base_name` in the interpreter.
- **TJ array CID mode**: `show_string_with_positioning_mode()` wraps `show_string_with_positioning` with a `cid_mode` flag to dispatch string elements to the CID 2-byte decoder.
- **lopdf object resolution**: Always resolve indirect references via `resolve_object(doc, obj)` before accessing dictionaries or arrays.
- **Width function pattern**: The interpreter creates a width closure `get_width_fn(cached)` that dispatches to CID or simple metrics.
- **CMap types**: `CMap` maps char_code→Unicode string (for ToUnicode). `CidCMap` maps char_code→CID (for predefined CMaps).
- **Type0 font loading flow**: `is_type0_font()` → `get_descendant_font()` → `extract_cid_font_metrics()` → stores in `CachedFont.cid_metrics`.
- **Spatial filtering pattern**: `PageData` trait provides shared access to page data (chars, lines, rects, curves, images). Both `Page` and `CroppedPage` implement it. `filter_and_build()` takes `&dyn PageData` + `BBox` + `FilterMode` to produce a `CroppedPage`. Coordinates adjusted by subtracting crop origin.
- **Page-level memory pattern**: `Pdf::page(index)` processes pages on-demand (interprets content stream per call). Page data is fully owned by `Page` (released on drop). `Pdf::pages_iter()` returns `PagesIter` (borrows `&Pdf`) that yields `Result<Page, PdfError>` — implements `ExactSizeIterator`. No shared state between pages; each page call is independent.
- **Serde feature flag pattern**: Use `#[cfg_attr(feature = "serde", derive(serde::Serialize, serde::Deserialize))]` on all public data types. Feature in pdfplumber-core, forwarded from pdfplumber via `pdfplumber-core/serde`. serde_json as dev-dependency for tests.
- **Parallel feature pattern**: `parallel = ["dep:rayon"]` in pdfplumber Cargo.toml. Methods gated with `#[cfg(feature = "parallel")]`. `Pdf` is naturally `Sync` (lopdf::Document is Send+Sync), so `&Pdf` can be shared across rayon threads. Test helpers for parallel-only code also need `#[cfg(feature = "parallel")]`.
- **Warning collection pattern**: `ExtractWarning` has `description`, `page`, `element`, `operator_index`, `font_name` fields. Interpreter emits warnings via `handler.on_warning()` gated by `options.collect_warnings`. The handler decorates warnings with page context. Page exposes `warnings()` accessor. Warnings are purely informational and never affect extraction output.
- **WASM/std feature pattern**: `std` feature (default) gates `Pdf::open_file()` behind `#[cfg(feature = "std")]`. Bytes-based `Pdf::open()` works everywhere. lopdf uses `default-features = false, features = ["nom_parser"]` to minimize deps. All three crates compile for `wasm32-unknown-unknown`.

# Ralph Progress Log
Started: 2026년  2월 28일 토요일 10시 21분 21초 KST
---

## 2026-02-28 - US-040
- Implemented CID font support: CID-to-GID mapping, predefined CMap parsing, /W and /DW width handling
- New file: `crates/pdfplumber-parse/src/cid_font.rs` — CidFontMetrics, CidToGidMap, CidSystemInfo, PredefinedCMapInfo, W array parsing, Type0 font detection
- Modified: `crates/pdfplumber-parse/src/cmap.rs` — Added CidCMap struct for begincidchar/begincidrange parsing, CMap name/WMode parsing
- Modified: `crates/pdfplumber-parse/src/interpreter.rs` — CachedFont now holds cid_metrics, is_cid_font, writing_mode; load_font_if_needed detects Type0 fonts; width lookup uses CID metrics when available
- Modified: `crates/pdfplumber-parse/src/lib.rs` — Exports new CID font types
- Dependencies added: none
- **Learnings for future iterations:**
  - /W array has two formats: `CID [w1 w2 ...]` (individual) and `CIDstart CIDend w` (range) — need to detect arrays vs integers
  - CIDToGIDMap is most commonly /Identity; explicit mapping is a raw byte stream of big-endian u16 pairs
  - Predefined CMap names follow patterns: Adobe-Japan1-*, UniJIS-UTF16-H, 90ms-RKSJ-H, etc.
  - clippy requires `#[allow(clippy::too_many_arguments)]` for constructors with 8+ params
  - Use `if let Ok(v) = x.parse()` not `if let Some(v) = x.parse().ok()` (clippy::match_result_ok)
---

## 2026-02-28 - US-041
- Implemented Identity-H/V support, subset font handling, and 2-byte character codes for CID fonts
- Modified: `crates/pdfplumber-parse/src/cid_font.rs` — Added `is_subset_font()` and `strip_subset_prefix()` functions with tests
- Modified: `crates/pdfplumber-parse/src/text_renderer.rs` — Added `show_string_cid()` for 2-byte character code decoding and `show_string_with_positioning_mode()` for TJ arrays with CID mode
- Modified: `crates/pdfplumber-parse/src/interpreter.rs` — Handle Tj/TJ dispatches to CID 2-byte mode for Type0 fonts; subset prefix stripping in font name extraction; integration tests for Identity-H, Identity-V, and subset font names
- Modified: `crates/pdfplumber-parse/src/lib.rs` — Exports new functions
- Dependencies added: none
- **Learnings for future iterations:**
  - CID fonts use 2-byte character codes (big-endian u16), simple fonts use 1-byte codes
  - Subset fonts follow strict pattern: exactly 6 uppercase letters + '+' + real name
  - Identity-H and Identity-V map CID = character code directly; difference is writing mode (0=horizontal, 1=vertical)
  - `is_some_and()` is a clean pattern for checking Option fields on borrowed references
---

## 2026-02-28 - US-042
- Implemented spatial filtering: crop, within_bbox, outside_bbox
- New file: `crates/pdfplumber/src/cropped_page.rs` — CroppedPage struct with full query API (chars, lines, rects, curves, images, edges, extract_words, extract_text, find_tables), filtering helpers (passes_filter, bbox_center, point_in_bbox, fully_within, fully_outside), coordinate adjustment, chained filtering support
- Modified: `crates/pdfplumber/src/page.rs` — Added crop(), within_bbox(), outside_bbox() methods to Page; implemented PageData trait for Page
- Modified: `crates/pdfplumber/src/lib.rs` — Registered cropped_page module, exported CroppedPage
- Dependencies added: none
- **Learnings for future iterations:**
  - Used `PageData` trait to share filtering logic between Page and CroppedPage (both can be filtered further)
  - Crop uses center-point test, within_bbox uses full containment, outside_bbox uses no-overlap
  - Coordinate adjustment: subtract crop bbox origin (dx, dy) from all coordinates including curve pts and char doctop
  - CroppedPage carries same query API as Page for seamless use in pipelines
---

## 2026-02-28 - US-043
- Added optional serde Serialize/Deserialize behind `serde` feature flag for all public data types
- Modified: `crates/pdfplumber-core/Cargo.toml` — Added `serde` feature flag, serde 1.0 as optional dep, serde_json as dev-dep
- Modified: `crates/pdfplumber/Cargo.toml` — Added `serde` feature forwarding to pdfplumber-core, serde_json as dev-dep
- Modified 10 source files in pdfplumber-core: geometry.rs, text.rs, painting.rs, shapes.rs, edges.rs, images.rs, words.rs, path.rs, table.rs, layout.rs — Added `#[cfg_attr(feature = "serde", derive(serde::Serialize, serde::Deserialize))]` to all public types
- New file: `crates/pdfplumber-core/tests/serde_roundtrip.rs` — 31 round-trip tests covering all public types
- Dependencies added: serde 1.0 (optional), serde_json 1.0 (dev-only)
- **Learnings for future iterations:**
  - `cfg_attr` pattern cleanly avoids pulling serde into the default build
  - serde_json dev-dependency is sufficient for testing; no runtime serde_json dependency needed
  - All types including nested ones (PathSegment→Point, Color→Vec<f32>) must have derives for parent derives to work
  - Feature forwarding: pdfplumber's `serde` feature enables `pdfplumber-core/serde` via Cargo dependency feature syntax
---

## 2026-02-28 - US-044
- Added optional rayon-based parallel page processing behind `parallel` feature flag
- Modified: `crates/pdfplumber/Cargo.toml` — Added `parallel` feature flag, rayon 1.10 as optional dep
- Modified: `crates/pdfplumber/src/pdf.rs` — Added `Pdf::pages_parallel()` method (behind `#[cfg(feature = "parallel")]`), 5 parallel tests (returns all pages, matches sequential, single page, doctop preservation, Sync compile check), multi-page PDF test helper
- Dependencies added: rayon 1.10 (optional, behind `parallel` feature)
- **Learnings for future iterations:**
  - `lopdf::Document` is `Send + Sync`, so `Pdf` is naturally `Sync` — no wrapper needed for `&Pdf` sharing across threads
  - rayon's `into_par_iter().map().collect()` is a clean 1:1 replacement for sequential iteration
  - `Pdf::page()` takes `&self` and all internal state (`doc`, `page_heights`, `raw_page_heights`, `options`) is read-only — inherently thread-safe
  - Test helpers used only with a feature must be gated with `#[cfg(feature = "...")]` to avoid dead_code warnings
  - `dep:rayon` syntax (not `rayon = ["rayon"]`) is the modern Cargo way to declare optional features
---

## 2026-02-28 - US-045
- Refined error/warning model: added context fields to ExtractWarning, wired up warning collection through the interpreter pipeline
- Modified: `crates/pdfplumber-core/src/error.rs` — Added `operator_index` and `font_name` fields to ExtractWarning, new `with_operator_context()` constructor, updated Display impl to show font/operator context
- Modified: `crates/pdfplumber-parse/src/handler.rs` — Added `on_warning(ExtractWarning)` to ContentHandler trait with default no-op
- Modified: `crates/pdfplumber-parse/src/interpreter.rs` — Emit warnings for font-not-found and font-metrics-failed; pass handler/options to load_font_if_needed; track operator index in loop
- Modified: `crates/pdfplumber/src/page.rs` — Added `warnings: Vec<ExtractWarning>` field and `warnings()` accessor
- Modified: `crates/pdfplumber/src/pdf.rs` — CollectingHandler now collects warnings with page context; wired through to Page construction
- Dependencies added: none
- **Learnings for future iterations:**
  - The codebase already had zero unwrap/expect/panic — defensive `unwrap_or` patterns were used throughout
  - Warning emission is best placed at the source (load_font_if_needed) with page context decorated by the handler
  - `collect_warnings: false` gates at the interpreter level (skips on_warning call entirely) for zero overhead
  - ContentHandler's `on_warning` default no-op keeps backward compatibility with existing handler implementations
  - The handler-decorator pattern (handler adds page number) keeps the interpreter page-agnostic
---

## 2026-02-28 - US-046
- Implemented page-level memory management: streaming iterator, page independence verification
- New type: `PagesIter<'a>` in `crates/pdfplumber/src/pdf.rs` — borrows `&Pdf`, yields `Result<Page, PdfError>`, implements `Iterator + ExactSizeIterator`
- New method: `Pdf::pages_iter()` — returns `PagesIter` for streaming page-by-page processing
- Modified: `crates/pdfplumber/src/lib.rs` — Exported `PagesIter`
- Added 12 new tests: pages_iter (yields all, correct content, matches page method, single page, exhaustion, size_hint, preserves doctop), page independence (no shared state, data released on drop), streaming iteration, page_count without processing, partial consumption
- Dependencies added: none
- **Learnings for future iterations:**
  - The existing `Pdf::page(index)` was already on-demand (content stream interpreted per call, not at open time)
  - Only lightweight metadata (MediaBox/CropBox/rotation) is cached at open time for doctop calculation
  - `Page` data is fully owned (Vec<Char>, Vec<Image>, etc.) — no shared references back to `Pdf`
  - `ExactSizeIterator` can be derived trivially since page_count is known upfront
  - Partial iteration (consuming only some pages) works cleanly — iterator drop is a no-op
---

## 2026-02-28 - US-047
- Implemented WASM build support: all three crates compile for wasm32-unknown-unknown
- Modified: `crates/pdfplumber-parse/Cargo.toml` — lopdf with `default-features = false, features = ["nom_parser"]` to exclude chrono/rayon from dependency tree
- Modified: `crates/pdfplumber/Cargo.toml` — Added `std` feature (default), `default = ["std"]`
- Modified: `crates/pdfplumber/src/pdf.rs` — Added `Pdf::open_file()` behind `#[cfg(feature = "std")]`; 3 std-gated tests (open_file_reads_valid_pdf, open_file_nonexistent_returns_error, open_file_matches_open_bytes) + 1 bytes API test
- Modified: `crates/pdfplumber/src/lib.rs` — Added WASM usage documentation and feature flags table to crate-level docs
- Modified: `scripts/ralph/prd.json` — Set US-047 passes: true
- Dependencies added: none (lopdf features trimmed)
- **Learnings for future iterations:**
  - lopdf 0.34 compiles for wasm32-unknown-unknown even with chrono (chrono uses `js-sys` for WASM). But disabling defaults reduces binary size.
  - The codebase had no `std::fs`, `std::time::Instant`, or other WASM-incompatible APIs — pure bytes-based design from the start
  - lopdf's `nom_parser` feature is the minimal set needed; `chrono_time` and `rayon` defaults are unnecessary
  - `PdfError::IoError(String)` already existed, perfect for wrapping `std::fs::read` errors
---

## 2026-02-28 - US-048
- Created performance benchmark suite using criterion crate
- New file: `crates/pdfplumber/benches/extraction.rs` — 8 benchmark groups: pdf_open, char_extraction, word_extraction, text_extraction, text_extraction_layout, table_detection_lattice, table_detection_stream, edge_computation
- New file: `crates/pdfplumber/benches/README.md` — Documents benchmark suite, test PDF descriptions, and baseline Python pdfplumber comparison numbers
- Modified: `crates/pdfplumber/Cargo.toml` — Added criterion 0.5 dev-dependency with html_reports feature, [[bench]] section
- Test PDFs generated programmatically: simple (1-page, 10 lines), medium (10-page, 30 lines each), complex (10-page, mixed fonts + 5x4 table each), lattice table (20x5 grid), stream table (20x5 text grid)
- Dependencies added: criterion 0.5 (dev-dependency only)
- **Benchmark results (Apple M-series)**:
  - Text extraction simple: ~0.12ms (vs Python ~5ms = ~40x faster)
  - Text extraction medium 10-page: ~4.8ms (vs Python ~50ms = ~10x faster)
  - Table detection lattice 20x5: ~0.12ms (vs Python ~15ms = ~125x faster)
  - Table detection stream 20x5: ~0.20ms (vs Python ~20ms = ~100x faster)
- **Learnings for future iterations:**
  - criterion's `--test` flag runs each benchmark once for quick compile/sanity check without timing
  - lopdf PDF generation helper pattern (build_pdf with content streams) is reusable for any test fixture
  - PDF content stream text positioning uses Td operator (relative move) — much cleaner than absolute positioning for multi-line text
  - Benchmark fixture functions should be separate from criterion groups for reusability
---

## 2026-02-28 - US-049
- Completed API documentation and crates.io release preparation
- Added `#![deny(missing_docs)]` to all three crate lib.rs files
- Added doc comments to 35 previously undocumented items: Point fields, Ctm fields, BBox fields/constructor, Orientation variants, PathSegment::CurveTo fields, Path::segments, TextRenderMode variants, Page::extract_table
- Expanded crate-level documentation with module listings and quick-start examples in all three lib.rs
- Created README.md with: project description, features, installation, quick-start examples (text/table/chars), WASM support, architecture diagram, MSRV, license
- Created 3 examples: extract_text.rs, extract_table.rs, extract_chars.rs
- Added Cargo.toml metadata: repository (workspace-level), keywords, and categories in all three crates
- Fixed 4 broken doc links (Page::crop/within_bbox/outside_bbox, ExtractOptions::collect_warnings)
- Added module-level doc comments to all 12 modules in pdfplumber-core
- **All checks pass**: cargo fmt, cargo clippy, cargo test, cargo check, cargo doc --workspace --no-deps
- Dependencies added: none
- **Learnings for future iterations:**
  - `#![deny(missing_docs)]` is the most reliable way to enforce documentation — RUSTFLAGS="-W missing_docs" for pre-check
  - Doc links to items behind feature flags (e.g., `pages_parallel` behind `parallel` feature) won't resolve in default docs build — use plain text instead of doc links
  - Doc links across crate boundaries need `crate::` prefix (e.g., `[`crate::Page::crop`]` not `[`Page::crop`]`)
  - `repository.workspace = true` in crate Cargo.toml forwards the workspace-level repository setting
  - crates.io allows max 5 keywords and requires categories from a predefined list
---
