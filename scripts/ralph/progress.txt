## Codebase Patterns

- **Font handling architecture**: Fonts are cached in `CachedFont` struct in interpreter.rs. Simple fonts use `FontMetrics` (widths array indexed by char_code - first_char). CID fonts use `CidFontMetrics` (HashMap<u32, f64> for sparse widths + default_width).
- **CID font 2-byte char codes**: CID fonts use `show_string_cid()` which reads pairs of bytes as big-endian u16 character codes. Simple fonts use `show_string()` with single-byte codes. The `is_cid_font` flag on `CachedFont` controls dispatch.
- **Subset font prefix**: PDF subset fonts use `ABCDEF+RealName` pattern. `strip_subset_prefix()` removes the 6-uppercase-letter prefix. Applied to all font `base_name` in the interpreter.
- **TJ array CID mode**: `show_string_with_positioning_mode()` wraps `show_string_with_positioning` with a `cid_mode` flag to dispatch string elements to the CID 2-byte decoder.
- **lopdf object resolution**: Always resolve indirect references via `resolve_object(doc, obj)` before accessing dictionaries or arrays.
- **Width function pattern**: The interpreter creates a width closure `get_width_fn(cached)` that dispatches to CID or simple metrics.
- **CMap types**: `CMap` maps char_code→Unicode string (for ToUnicode). `CidCMap` maps char_code→CID (for predefined CMaps).
- **Type0 font loading flow**: `is_type0_font()` → `get_descendant_font()` → `extract_cid_font_metrics()` → stores in `CachedFont.cid_metrics`.
- **Spatial filtering pattern**: `PageData` trait provides shared access to page data (chars, lines, rects, curves, images). Both `Page` and `CroppedPage` implement it. `filter_and_build()` takes `&dyn PageData` + `BBox` + `FilterMode` to produce a `CroppedPage`. Coordinates adjusted by subtracting crop origin.
- **Serde feature flag pattern**: Use `#[cfg_attr(feature = "serde", derive(serde::Serialize, serde::Deserialize))]` on all public data types. Feature in pdfplumber-core, forwarded from pdfplumber via `pdfplumber-core/serde`. serde_json as dev-dependency for tests.

# Ralph Progress Log
Started: 2026년  2월 28일 토요일 10시 21분 21초 KST
---

## 2026-02-28 - US-040
- Implemented CID font support: CID-to-GID mapping, predefined CMap parsing, /W and /DW width handling
- New file: `crates/pdfplumber-parse/src/cid_font.rs` — CidFontMetrics, CidToGidMap, CidSystemInfo, PredefinedCMapInfo, W array parsing, Type0 font detection
- Modified: `crates/pdfplumber-parse/src/cmap.rs` — Added CidCMap struct for begincidchar/begincidrange parsing, CMap name/WMode parsing
- Modified: `crates/pdfplumber-parse/src/interpreter.rs` — CachedFont now holds cid_metrics, is_cid_font, writing_mode; load_font_if_needed detects Type0 fonts; width lookup uses CID metrics when available
- Modified: `crates/pdfplumber-parse/src/lib.rs` — Exports new CID font types
- Dependencies added: none
- **Learnings for future iterations:**
  - /W array has two formats: `CID [w1 w2 ...]` (individual) and `CIDstart CIDend w` (range) — need to detect arrays vs integers
  - CIDToGIDMap is most commonly /Identity; explicit mapping is a raw byte stream of big-endian u16 pairs
  - Predefined CMap names follow patterns: Adobe-Japan1-*, UniJIS-UTF16-H, 90ms-RKSJ-H, etc.
  - clippy requires `#[allow(clippy::too_many_arguments)]` for constructors with 8+ params
  - Use `if let Ok(v) = x.parse()` not `if let Some(v) = x.parse().ok()` (clippy::match_result_ok)
---

## 2026-02-28 - US-041
- Implemented Identity-H/V support, subset font handling, and 2-byte character codes for CID fonts
- Modified: `crates/pdfplumber-parse/src/cid_font.rs` — Added `is_subset_font()` and `strip_subset_prefix()` functions with tests
- Modified: `crates/pdfplumber-parse/src/text_renderer.rs` — Added `show_string_cid()` for 2-byte character code decoding and `show_string_with_positioning_mode()` for TJ arrays with CID mode
- Modified: `crates/pdfplumber-parse/src/interpreter.rs` — Handle Tj/TJ dispatches to CID 2-byte mode for Type0 fonts; subset prefix stripping in font name extraction; integration tests for Identity-H, Identity-V, and subset font names
- Modified: `crates/pdfplumber-parse/src/lib.rs` — Exports new functions
- Dependencies added: none
- **Learnings for future iterations:**
  - CID fonts use 2-byte character codes (big-endian u16), simple fonts use 1-byte codes
  - Subset fonts follow strict pattern: exactly 6 uppercase letters + '+' + real name
  - Identity-H and Identity-V map CID = character code directly; difference is writing mode (0=horizontal, 1=vertical)
  - `is_some_and()` is a clean pattern for checking Option fields on borrowed references
---

## 2026-02-28 - US-042
- Implemented spatial filtering: crop, within_bbox, outside_bbox
- New file: `crates/pdfplumber/src/cropped_page.rs` — CroppedPage struct with full query API (chars, lines, rects, curves, images, edges, extract_words, extract_text, find_tables), filtering helpers (passes_filter, bbox_center, point_in_bbox, fully_within, fully_outside), coordinate adjustment, chained filtering support
- Modified: `crates/pdfplumber/src/page.rs` — Added crop(), within_bbox(), outside_bbox() methods to Page; implemented PageData trait for Page
- Modified: `crates/pdfplumber/src/lib.rs` — Registered cropped_page module, exported CroppedPage
- Dependencies added: none
- **Learnings for future iterations:**
  - Used `PageData` trait to share filtering logic between Page and CroppedPage (both can be filtered further)
  - Crop uses center-point test, within_bbox uses full containment, outside_bbox uses no-overlap
  - Coordinate adjustment: subtract crop bbox origin (dx, dy) from all coordinates including curve pts and char doctop
  - CroppedPage carries same query API as Page for seamless use in pipelines
---

## 2026-02-28 - US-043
- Added optional serde Serialize/Deserialize behind `serde` feature flag for all public data types
- Modified: `crates/pdfplumber-core/Cargo.toml` — Added `serde` feature flag, serde 1.0 as optional dep, serde_json as dev-dep
- Modified: `crates/pdfplumber/Cargo.toml` — Added `serde` feature forwarding to pdfplumber-core, serde_json as dev-dep
- Modified 10 source files in pdfplumber-core: geometry.rs, text.rs, painting.rs, shapes.rs, edges.rs, images.rs, words.rs, path.rs, table.rs, layout.rs — Added `#[cfg_attr(feature = "serde", derive(serde::Serialize, serde::Deserialize))]` to all public types
- New file: `crates/pdfplumber-core/tests/serde_roundtrip.rs` — 31 round-trip tests covering all public types
- Dependencies added: serde 1.0 (optional), serde_json 1.0 (dev-only)
- **Learnings for future iterations:**
  - `cfg_attr` pattern cleanly avoids pulling serde into the default build
  - serde_json dev-dependency is sufficient for testing; no runtime serde_json dependency needed
  - All types including nested ones (PathSegment→Point, Color→Vec<f32>) must have derives for parent derives to work
  - Feature forwarding: pdfplumber's `serde` feature enables `pdfplumber-core/serde` via Cargo dependency feature syntax
---
