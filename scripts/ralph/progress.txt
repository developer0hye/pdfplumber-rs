# Ralph Progress Log
Started: 2026년  3월  1일 일요일 10시 16분 06초 KST

## Codebase Patterns
- **HashMap bucketing for spatial clustering**: Use `HashMap<i64, Vec<usize>>` keyed by quantized coordinate `(value / bucket_size).floor() as i64` for O(1) spatial lookups. Check adjacent buckets (key±1) for boundary tolerance. Update bucket registration when the aggregate bbox changes.
- Char fields use `c.bbox.x0`, `c.bbox.top`, etc. (not `c.x0` directly)
- Word fields also use `w.bbox.x0`, etc.
- lopdf imports must be alphabetically ordered for cargo fmt: `use lopdf::{Document, Object, Stream, dictionary};`
- Test helpers: `fixtures_dir()`, `generated(name)`, `open_fixture(path)` pattern
- pdfplumber-py tests fail due to missing Python dylib — exclude with `--exclude pdfplumber-py`
- Rotation fixture `rotated_pages.pdf` has 4 pages (0°, 90°, 180°, 270°) generated by fpdf2 + pypdf
- Our implementation correctly normalizes rotated page coordinates — text extracts in proper reading order for all rotations
- Table detection works on rotated pages without modification — edges from content stream are transformed by PageGeometry

---

## 2026-03-01 - US-152-1
- Optimized `cluster_words_into_lines` from O(n²) to O(n log n) using y-coordinate bucketing
- Replaced linear scan of all lines with `HashMap<i64, Vec<usize>>` keyed by quantized mid_y
- Adjacent bucket checking (±1) handles tolerance boundary cases
- Bucket registration updated when line bbox grows from word union
- Added 6 new tests: all-same-line, overlapping y-ranges, large tolerance, zero tolerance, 10k-word benchmark, sub-quadratic scaling verification
- Files changed: `crates/pdfplumber-core/src/layout.rs`
- Dependencies added: None (uses `std::collections::HashMap`)
- **Learnings for future iterations:**
  - The old O(n²) algorithm showed 12.3x scaling for 4x input; optimized version shows ~4x (linear)
  - When using bucket_size = y_tolerance, checking 3 buckets (word_bucket ± 1) guarantees finding any line within tolerance
  - Zero tolerance requires special bucket_size (1e-9) to avoid division by zero
  - pdfplumber-py tests fail locally due to missing libpython3.11 — pre-existing environment issue, not related to changes
---

## 2026-03-01 - US-153-1
- Changed `UnicodeNorm` default from `None` to `Nfc` (moved `#[default]` attribute)
- Updated doc comments: `Nfc` now says "(default)", `None` no longer does
- Changed `ExtractOptions::default()` to use `UnicodeNorm::Nfc`
- Added `ExtractOptions::for_llm()` constructor with NFC normalization
- Updated `ExtractOptions` doc comment for `unicode_norm` field
- Updated tests: `unicode_norm_default_is_nfc`, `extract_options_default_values`, new `extract_options_for_llm`
- Files changed:
  - `crates/pdfplumber-core/src/unicode_norm.rs` (enum default + doc comments + test)
  - `crates/pdfplumber-core/src/error.rs` (default impl + for_llm() + doc comment + tests)
- Dependencies added: none
- **Learnings for future iterations:**
  - `pdf.rs:478` uses `!= UnicodeNorm::None` for skip-normalization check — this pattern works regardless of default
  - pdfplumber-py tests fail locally due to missing libpython3.11 — pre-existing env issue, CI handles it
  - The `extract_options_custom_values` test explicitly sets `UnicodeNorm::None` which is fine (testing custom, not default)
  - When main diverges significantly, reset branch to main and re-apply changes rather than rebasing
  - Cross-validation and accuracy benchmark tests compare against golden data generated without normalization. Must use explicit `UnicodeNorm::None` when opening PDFs for golden data comparison.
  - `U+037E` (Greek Question Mark) NFC-normalizes to `U+003B` (semicolon) — caused cv_python_issue_905 failure until cross-validation/accuracy tests were fixed
  - Also updated: `cross_validation.rs`, `accuracy_benchmark.rs` (explicit `UnicodeNorm::None`), `pdf_integration.rs` (comment fix)
---

## 2026-03-01 - US-154-1
- What was implemented: 29 integration tests for text extraction on rotated pages (0°, 90°, 180°, 270°)
- Files changed:
  - `crates/pdfplumber/tests/rotation_integration.rs` (new, 720 lines)
  - `scripts/ralph/prd.json` (marked US-154-1 passes: true)
  - `scripts/ralph/progress.txt` (this file)
- Dependencies added: None
- **Learnings for future iterations:**
  - The existing rotated_pages.pdf fixture works well — all rotations extract correctly
  - pdfplumber-rs handles rotation better than Python pdfplumber for this fixture (Python produces reversed text for 180°/270°, Rust extracts correctly)
  - lopdf can create test PDFs programmatically with `Document::with_version`, `dictionary!`, `Stream`
  - PageGeometry normalizes all coordinates to top-left origin regardless of /Rotate value
  - For 90°/270° rotations, page width and height are correctly swapped
---

## 2026-03-01 - US-154-2
- What was implemented: 21 integration tests for table detection on rotated pages (0°, 90°, 180°)
- Tests verify: table detection, row count, cell text extraction, page text readability, edge existence, bbox bounds, multi-rotation document
- All tests pass — table detection works correctly on rotated pages without any code changes needed
- Files changed:
  - `crates/pdfplumber/tests/rotation_table_integration.rs` (new, ~500 lines)
  - `scripts/ralph/prd.json` (marked US-154-2 passes: true)
  - `scripts/ralph/progress.txt` (this file)
- Dependencies added: None
- **Learnings for future iterations:**
  - Table detection works out of the box on rotated pages — PageGeometry's coordinate normalization handles edges/lines correctly
  - Content stream drawing operators (m/l/S) for grid lines are properly transformed through the rotation matrix
  - lopdf content streams for tables: use `{x} {y} m {x2} {y2} l S` for lines, combine with `BT /F1 {size} Tf {x} {y} Td ({text}) Tj ET` for cell text
  - No `#[ignore]` needed — the PRD anticipated possible failures but the implementation handles rotation correctly
---

## 2026-03-01 - US-155-1, US-155-2, US-155-3
- Deleted `crates/pdfplumber-core/src/markdown.rs` (1,065 lines removed)
- Deleted `crates/pdfplumber-core/src/markdown_conversion.rs` (also added in main, removed as part of markdown cleanup)
- Removed `pub mod markdown;` and `pub use markdown::{MarkdownOptions, MarkdownRenderer};` from `crates/pdfplumber-core/src/lib.rs`
- Removed `MarkdownOptions` and `MarkdownRenderer` from re-exports in `crates/pdfplumber/src/lib.rs`
- Removed `MarkdownOptions`/`MarkdownRenderer` imports and `Page::to_markdown()` method from `crates/pdfplumber/src/page.rs`
- Removed `Markdown` variant from `TextFormat` enum in `crates/pdfplumber-cli/src/cli.rs`
- Removed `TextFormat::Markdown` match arm and `MarkdownOptions` import from `crates/pdfplumber-cli/src/text_cmd.rs`
- Removed `TextFormat::Markdown` from pattern matches in `crates/pdfplumber-cli/src/bookmarks_cmd.rs` and `crates/pdfplumber-cli/src/info_cmd.rs`
- No markdown references remain in the codebase (verified with grep)
- All quality checks pass: fmt, clippy, check, test (pdfplumber-py excluded due to pre-existing libpython3.11 env issue)
- Dependencies added: none
- **Learnings for future iterations:**
  - Deletion tasks across layered crates (core → facade → cli) are straightforward — work bottom-up
  - When merging with main, new markdown-related modules (markdown_conversion) may have been added — need to remove those too
  - pdfplumber-py tests fail due to missing libpython3.11.dylib — pre-existing env issue, not related to changes
---
