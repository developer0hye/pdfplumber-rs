# Ralph Progress Log
Started: 2026년  2월 28일 토요일 18시 13분 54초 KST

## Codebase Patterns
- **PyO3 module name conflict**: The pymodule function name `pdfplumber` conflicts with the external crate name `pdfplumber`. Use `::pdfplumber` to reference the external crate in imports.
- **lopdf dictionary macro**: In Rust 2024 edition, `lopdf::dictionary!` macro requires explicit import: `use lopdf::dictionary;`
- **Test PDFs**: Create minimal PDFs programmatically using `lopdf::Document::with_version("1.7")` + manual page tree construction. See `crates/pdfplumber-py/src/lib.rs` tests for pattern.
- **Workspace member addition**: Add new crates to root `Cargo.toml` `[workspace] members` array.
- **Crate lib naming**: When lib name differs from package name (e.g., `name = "pdfplumber"` in pdfplumber-py), use `[lib] name = "pdfplumber"` in Cargo.toml.
- **PyO3 extension-module feature**: Must be a Cargo feature flag, NOT a direct pyo3 dependency feature. Direct use prevents test linking. Use `features = ["extension-module"]` in `[features]` and activate via maturin's `pyproject.toml`.
- **PyO3 test setup**: Add `pyo3 = { version = "0.24", features = ["auto-initialize"] }` in `[dev-dependencies]` and add `"rlib"` to `crate-type` for test linking. Set `doctest = false` to avoid rlib name collision with the `pdfplumber` crate.
- **Rust→Python dict conversion**: Use `PyDict::new(py)` + `set_item()` for converting Rust structs to Python dicts. For `Option<T>`, use `py.None()` for the None case.
- **wasm-bindgen non-wasm targets**: `JsError::new()` panics on non-wasm targets ("cannot call wasm-bindgen imported functions"). Test error paths via underlying Rust API instead of through wasm-bindgen wrappers.
- **wasm-bindgen crate setup**: Use `crate-type = ["cdylib", "rlib"]` (cdylib for wasm-pack output, rlib for tests). Set `doctest = false` to avoid issues.
- **serde_wasm_bindgen**: Use `serde_wasm_bindgen::to_value()` for complex Rust→JsValue conversion. Enable `serde` feature on the pdfplumber dependency.
- **WASM pdfplumber dependency**: Use `default-features = false, features = ["serde"]` to disable filesystem APIs (`open_file`) and enable serialization.

---

## 2026-02-28 - US-073
- What was implemented: PyO3 crate scaffolding for Python bindings
- Files changed:
  - `Cargo.toml` (workspace root) — added `crates/pdfplumber-py` to members
  - `crates/pdfplumber-py/Cargo.toml` — new crate with pyo3 + pdfplumber deps
  - `crates/pdfplumber-py/pyproject.toml` — maturin build backend
  - `crates/pdfplumber-py/src/lib.rs` — PyPdf (open/open_bytes/pages) + PyPage (page_number/width/height) + 4 Rust tests
- Dependencies added: `pyo3 0.24` (with extension-module feature), `lopdf 0.34` (dev-dependency for test PDF generation)
- **Learnings for future iterations:**
  - PyO3 0.24 pymodule signature: `fn name(m: &Bound<'_, PyModule>) -> PyResult<()>`
  - `crate-type = ["cdylib"]` is required for Python extension modules
  - Tests can verify the wrapper logic without the Python interpreter by testing inner field access directly
---

## 2026-02-28 - US-074
- What was implemented: Full Python API exposure for pdfplumber-rs
- Files changed:
  - `crates/pdfplumber-py/Cargo.toml` — added `rlib` crate-type, `auto-initialize` dev-dep, `extension-module` feature flag, `doctest = false`
  - `crates/pdfplumber-py/pyproject.toml` — updated to use `extension-module` feature
  - `crates/pdfplumber-py/src/lib.rs` — expanded from 165 to 1340+ lines:
    - PyPage: chars(), extract_text(), extract_words(), find_tables(), extract_tables(), lines(), rects(), curves(), images(), search(), crop(), within_bbox(), outside_bbox()
    - PyPdf: metadata getter, bookmarks() method
    - PyTable class: bbox, rows, accuracy, extract()
    - PyCroppedPage class: full content access + spatial filtering
    - 7 custom Python exception types (PdfParseError, PdfIoError, PdfFontError, PdfInterpreterError, PdfResourceLimitError, PdfPasswordRequired, PdfInvalidPassword)
    - 10 conversion helpers (char_to_dict, word_to_dict, line_to_dict, etc.)
    - 42 Rust unit tests
- Dependencies added: None (reused existing pyo3 0.24)
- **Learnings for future iterations:**
  - `extension-module` must be conditional — unconditional use prevents test linking to libpython
  - `DYLD_LIBRARY_PATH` may be needed for local test runs on macOS
  - `create_exception!` macro creates Python exception types that can be registered with `m.add()`
  - All Rust types can be converted to Python dicts via PyDict; complex nested types work well
---

## 2026-02-28 - US-075
- What was implemented: PyPI packaging for pdfplumber-py
- Files changed:
  - `crates/pdfplumber-py/pyproject.toml` — added full PyPI metadata: description, license, classifiers, authors, keywords, project URLs, readme
  - `crates/pdfplumber-py/src/lib.rs` — added `VERSION` constant (`env!("CARGO_PKG_VERSION")`), `__version__` module attribute, 7 new tests for packaging
  - `crates/pdfplumber-py/pdfplumber.pyi` — new Python type stubs for all classes (PDF, Page, Table, CroppedPage), exception types, and type aliases
  - `crates/pdfplumber-py/README.md` — new PyPI README with installation, quick start, API reference, comparison table, performance notes
- Dependencies added: None
- **Learnings for future iterations:**
  - `env!("CARGO_PKG_VERSION")` provides compile-time version from Cargo.toml
  - maturin auto-detects `.pyi` files in the crate directory and includes them in the wheel
  - `dynamic = ["version"]` in pyproject.toml makes maturin read version from Cargo.toml
  - `readme = "README.md"` in pyproject.toml includes the README in the PyPI listing
  - Tests can verify packaging artifacts (file existence, content assertions) using `env!("CARGO_MANIFEST_DIR")`
---

## 2026-02-28 - US-076
- What was implemented: WASM/JS bindings via wasm-bindgen
- Files changed:
  - `Cargo.toml` (workspace root) — added `crates/pdfplumber-wasm` to members
  - `crates/pdfplumber-wasm/Cargo.toml` — new crate with wasm-bindgen, serde-wasm-bindgen, pdfplumber (serde feature)
  - `crates/pdfplumber-wasm/src/lib.rs` — WasmPdf (open/pageCount/page/metadata) + WasmPage (pageNumber/width/height/chars/extractText/extractWords/findTables/extractTables/search) + 18 Rust tests
  - `crates/pdfplumber-wasm/tests/test.mjs` — JavaScript test script for manual verification
- Dependencies added: `wasm-bindgen 0.2`, `serde-wasm-bindgen 0.6`, `wasm-bindgen-test 0.3` (dev-dep)
- **Learnings for future iterations:**
  - `JsError::new()` panics on non-wasm targets — error path tests must use underlying Rust API
  - `serde_wasm_bindgen::to_value()` also panics on non-wasm — test JsValue methods only in wasm-bindgen-test
  - wasm-pack auto-generates TypeScript `.d.ts` files with proper types
  - Static methods in `#[wasm_bindgen] impl` blocks (no `&self`) become JS static class methods
  - `#[wasm_bindgen(getter, js_name = "camelCase")]` for JS-idiomatic property names
  - Rust 2024 edition: `ref mut` not allowed in implicitly-borrowing patterns (lopdf dictionary matching)
- **npm packaging pattern**: wasm-pack auto-generates `package.json`, `.d.ts`, and `.js` in `pkg/` from Cargo.toml metadata. Create hand-crafted `.d.ts` with richer types alongside the crate for IDE consumers. wasm-pack also copies `README.md` from crate root into `pkg/`.
---

## 2026-02-28 - US-077
- What was implemented: npm packaging for pdfplumber-wasm
- Files changed:
  - `crates/pdfplumber-wasm/pdfplumber-wasm.d.ts` — new hand-crafted TypeScript type definitions with rich interfaces (PdfChar, PdfWord, PdfTable, PdfSearchMatch, PdfMetadata, WasmPdf, WasmPage)
  - `crates/pdfplumber-wasm/README.md` — new npm README with installation, browser/Node.js/bundler usage, API reference, comparison table
  - `crates/pdfplumber-wasm/examples/browser-demo.html` — new browser demo with drag-and-drop PDF loading, text/word/table extraction
  - `crates/pdfplumber-wasm/src/lib.rs` — added 10 packaging artifact tests
- Dependencies added: None
- **Learnings for future iterations:**
  - wasm-pack `--target bundler` generates `module` field in package.json (ES module), `--target nodejs` generates `main` (CommonJS)
  - wasm-pack copies README.md from crate root into the `pkg/` output directory
  - Hand-crafted `.d.ts` with proper interfaces is valuable since auto-generated types use `any` for `JsValue` returns
  - The `pkg/` directory is gitignored (has `*` in `.gitignore`) — source artifacts go in the crate root
  - File existence tests using `env!("CARGO_MANIFEST_DIR")` are reliable for verifying packaging artifacts
---
