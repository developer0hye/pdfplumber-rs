## Codebase Patterns
- **HashMap bucketing for spatial clustering**: Use `HashMap<i64, Vec<usize>>` keyed by quantized coordinate `(value / bucket_size).floor() as i64` for O(1) spatial lookups. Check adjacent buckets (key±1) for boundary tolerance. Update bucket registration when the aggregate bbox changes.

---

# Ralph Progress Log
Started: 2026년  3월  1일 일요일 10시 16분 06초 KST
---

## 2026-03-01 - US-152-1
- Optimized `cluster_words_into_lines` from O(n²) to O(n log n) using y-coordinate bucketing
- Replaced linear scan of all lines with `HashMap<i64, Vec<usize>>` keyed by quantized mid_y
- Adjacent bucket checking (±1) handles tolerance boundary cases
- Bucket registration updated when line bbox grows from word union
- Added 6 new tests: all-same-line, overlapping y-ranges, large tolerance, zero tolerance, 10k-word benchmark, sub-quadratic scaling verification
- Files changed: `crates/pdfplumber-core/src/layout.rs`
- Dependencies added: None (uses `std::collections::HashMap`)
- **Learnings for future iterations:**
  - The old O(n²) algorithm showed 12.3x scaling for 4x input; optimized version shows ~4x (linear)
  - When using bucket_size = y_tolerance, checking 3 buckets (word_bucket ± 1) guarantees finding any line within tolerance
  - Zero tolerance requires special bucket_size (1e-9) to avoid division by zero
  - pdfplumber-py tests fail locally due to missing libpython3.11 — pre-existing environment issue, not related to changes
---
