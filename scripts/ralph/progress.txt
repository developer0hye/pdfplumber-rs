## Codebase Patterns
- Workspace uses `edition.workspace = true` and `rust-version.workspace = true` to inherit from root
- Crate directory structure: `crates/<name>/Cargo.toml` + `crates/<name>/src/lib.rs`
- Dependency chain: pdfplumber → {pdfplumber-core, pdfplumber-parse}, pdfplumber-parse → pdfplumber-core
- pdfplumber-core has zero external dependencies (pure algorithms)
- Quality checks: `cargo fmt --all -- --check && cargo clippy --workspace -- -D warnings && cargo test --workspace && cargo check --workspace`
- CJK detection: `is_cjk(char)` / `is_cjk_text(&str)` in `text.rs` — covers 11 Unicode blocks
- TextDirection enum (Ltr/Rtl/Ttb/Btt) in `text.rs` — controls sorting and gap logic in WordExtractor
- CJK tolerance pattern: use `last_char.bbox.width().max(base_tolerance)` for horizontal, `.height()` for vertical
- Geometric primitives: `Point(x, y)` and `Ctm(a, b, c, d, e, f)` in `geometry.rs`
- CTM transform: `(x', y') = (a*x + c*y + e, b*x + d*y + f)` — row-vector convention
- PathBuilder stores CTM-transformed coordinates; current_point is always in device space
- `v` operator uses already-transformed current_point as cp1 (no double transform)
- `re` operator delegates to move_to/line_to/close_path for consistent CTM handling
- Shape extraction: `extract_shapes(painted, page_height) -> (Vec<Line>, Vec<Rect>)` in `shapes.rs`
- y-flip: `top_origin_y = page_height - pdf_y` for coordinate conversion
- Rect detection: axis-aligned closed 4-vertex subpath OR 5-vertex where last==first
- Line extraction: only from stroked paths (fill-only non-rects produce nothing)
- ClosePath generates a closing Line segment back to subpath start if start != current
---

# Ralph Progress Log - Phase 2: Words & Geometry - Word Grouping, Path Extraction, Reading Order
Started: 2026년  2월 27일 금요일 23시 36분 31초 KST
---

## 2026-02-27 - US-018: WordExtractor - tolerance-based character grouping
- **What was implemented:**
  - `BBox` type in `crates/pdfplumber-core/src/geometry.rs` — bounding box with top-left origin (x0, top, x1, bottom), with union/width/height methods
  - `Char` type in `crates/pdfplumber-core/src/text.rs` — character with text, bbox, fontname, size
  - `WordOptions` struct with pdfplumber-compatible defaults (x_tolerance=3, y_tolerance=3, keep_blank_chars=false, use_text_flow=false)
  - `Word` struct with text, bbox (union of char bboxes), and constituent chars
  - `WordExtractor::extract()` — groups chars into words by spatial proximity with sorting, space handling, and tolerance-based grouping
- **Files changed:**
  - `crates/pdfplumber-core/src/lib.rs` — module declarations and re-exports
  - `crates/pdfplumber-core/src/geometry.rs` (new) — BBox type
  - `crates/pdfplumber-core/src/text.rs` (new) — Char type
  - `crates/pdfplumber-core/src/words.rs` (new) — Word, WordOptions, WordExtractor + 21 unit tests
- **Dependencies added:** None (pure Rust, zero dependencies)
- **Learnings for future iterations:**
  - Keep modules flat (geometry.rs, text.rs, words.rs) rather than nested — simpler and matches crate convention
  - `BBox::union()` is the key primitive for composing bounding boxes — will be reused across many features
  - Word extraction gap check: `x_gap = next.x0 - prev.x1`, new word if `> x_tolerance` or `y_diff > y_tolerance`
  - Sorting by (top, x0) before grouping handles out-of-order chars from PDF content streams
---

## 2026-02-27 - US-019: Page::extract_words() API + Word type integration
- **What was implemented:**
  - `Page` struct in `crates/pdfplumber/src/page.rs` — holds page metadata (page_number, width, height) and extracted chars
  - `Page::new()` constructor, accessor methods: `page_number()`, `width()`, `height()`, `chars()`
  - `Page::extract_words(&self, options: &WordOptions) -> Vec<Word>` — delegates to `WordExtractor::extract()`
  - Public re-exports from `crates/pdfplumber/src/lib.rs`: `Page`, `BBox`, `Char`, `Word`, `WordExtractor`, `WordOptions`
  - 9 unit tests covering: page creation, chars access, word extraction with default/custom options, text concatenation, bbox calculation, multiline, empty page, constituent chars
- **Files changed:**
  - `crates/pdfplumber/src/page.rs` (new) — Page type + 9 tests
  - `crates/pdfplumber/src/lib.rs` — added page module, public re-exports
- **Dependencies added:** None
- **Learnings for future iterations:**
  - The pdfplumber facade crate re-exports core types so users only need `use pdfplumber::{Page, WordOptions}`
  - Page is constructed from pre-extracted chars; actual PDF parsing will feed chars into Page later
  - Test modules within the facade crate need explicit `use pdfplumber_core::BBox` since `super::*` only imports from the module scope, not the crate re-exports
---

## 2026-02-27 - US-020: CJK word grouping - character-width-based tolerance
- **What was implemented:**
  - `TextDirection` enum (Ltr, Rtl, Ttb, Btt) in `crates/pdfplumber-core/src/text.rs`
  - `is_cjk(char)` and `is_cjk_text(&str)` functions covering 11 Unicode blocks (CJK Unified, Hiragana, Katakana, Hangul, Bopomofo, etc.)
  - CJK-aware tolerance in `WordExtractor`: uses `char.bbox.width()` as tolerance for CJK chars instead of fixed `x_tolerance`
  - Vertical text support: `TextDirection::Ttb/Btt` — sorts columns right-to-left, uses `y_gap` and char height as tolerance
  - `text_direction` field added to `WordOptions` (default: Ltr, backward-compatible)
  - Helper methods: `effective_x_tolerance()`, `effective_y_tolerance()`, `should_split_horizontal()`, `should_split_vertical()`
  - 12 new CJK-specific tests + 8 `is_cjk`/TextDirection tests (total: 53 tests in workspace)
- **Files changed:**
  - `crates/pdfplumber-core/src/text.rs` — TextDirection enum, is_cjk(), is_cjk_text(), 8 tests
  - `crates/pdfplumber-core/src/words.rs` — CJK tolerance logic, vertical text support, 12 CJK tests
  - `crates/pdfplumber-core/src/lib.rs` — re-export TextDirection, is_cjk, is_cjk_text
  - `crates/pdfplumber/src/lib.rs` — re-export new types from facade
- **Dependencies added:** None (still pure Rust, zero dependencies)
- **Learnings for future iterations:**
  - CJK tolerance pattern: `last.bbox.width().max(base_tolerance)` — uses char width as minimum, falls back to configured tolerance
  - Vertical text sorting: (x0 descending, top ascending) — right-to-left columns, top-to-bottom within column
  - Vertical gap check: `y_gap = current.top - last.bottom` and `x_diff` for column detection
  - `is_some_and()` is cleaner than `map_or(false, ...)` for Option predicate checks
---

## 2026-02-28 - US-021: Graphics path operators - m, l, c, v, y, h, re
- **What was implemented:**
  - `Point` struct in `crates/pdfplumber-core/src/geometry.rs` — simple 2D point (x, y)
  - `Ctm` struct in `geometry.rs` — Current Transformation Matrix with identity, new, transform_point, concat methods
  - `PathSegment` enum in `crates/pdfplumber-core/src/path.rs` — MoveTo, LineTo, CurveTo, ClosePath
  - `Path` struct — collection of path segments
  - `PathBuilder` struct — builds paths from PDF operators with CTM transformation
  - All 7 PDF path operators: m (move_to), l (line_to), c (curve_to), v (curve_to_v), y (curve_to_y), h (close_path), re (rectangle)
  - All coordinates transformed through CTM before storage
  - 24 path tests + 10 geometry tests (Point/Ctm) = 34 new tests (total: 87 in workspace)
- **Files changed:**
  - `crates/pdfplumber-core/src/geometry.rs` — added Point, Ctm types + 10 tests
  - `crates/pdfplumber-core/src/path.rs` (new) — PathSegment, Path, PathBuilder + 24 tests
  - `crates/pdfplumber-core/src/lib.rs` — added path module, re-exports for Point, Ctm, Path, PathBuilder, PathSegment
  - `crates/pdfplumber/src/lib.rs` — re-export new types from facade
- **Dependencies added:** None (still pure Rust, zero dependencies)
- **Learnings for future iterations:**
  - PathBuilder stores device-space (CTM-transformed) coordinates — current_point is always post-transform
  - `v` operator: cp1 = current_point (already transformed), cp2/end need CTM transform
  - `y` operator: cp2 = end point (both need CTM transform)
  - `re` operator delegates to move_to/line_to/close_path for consistent CTM handling
  - CTM concat: `a.concat(&b)` = `a × b` — used for cm operator in content stream
  - `subpath_start` tracks the most recent MoveTo for close_path to return to
- Painting operations consume PathBuilder segments via `take_and_reset()` and reset for next path
- `PaintedPath` captures path + stroke/fill flags + fill_rule + colors + line_width at painting time
---

## 2026-02-28 - US-022: Path painting operators - S, s, f, F, f*, B, B*, b, b*, n
- **What was implemented:**
  - `Color` struct (RGB, default black) in `crates/pdfplumber-core/src/painting.rs`
  - `FillRule` enum (NonZeroWinding default, EvenOdd) in `painting.rs`
  - `GraphicsState` struct (line_width, stroke_color, fill_color) in `painting.rs`
  - `PaintedPath` struct — path + stroke/fill flags + fill_rule + colors + line_width
  - Painting methods on `PathBuilder` (impl in `painting.rs`):
    - `stroke()` — S operator
    - `close_and_stroke()` — s operator (h then S)
    - `fill()` — f/F operator (nonzero winding)
    - `fill_even_odd()` — f* operator (even-odd rule)
    - `fill_and_stroke()` — B operator
    - `fill_even_odd_and_stroke()` — B* operator
    - `close_fill_and_stroke()` — b operator
    - `close_fill_even_odd_and_stroke()` — b* operator
    - `end_path()` — n operator (returns None, discards path)
  - `take_and_reset()` method on `PathBuilder` — consumes segments and resets for next path
  - 26 unit tests covering all operators, graphics state capture, path clearing, curves, CTM, sequential paints
- **Files changed:**
  - `crates/pdfplumber-core/src/painting.rs` (new) — Color, FillRule, GraphicsState, PaintedPath + painting methods + 26 tests
  - `crates/pdfplumber-core/src/path.rs` — added `take_and_reset()` method to PathBuilder
  - `crates/pdfplumber-core/src/lib.rs` — added painting module, re-exports
  - `crates/pdfplumber/src/lib.rs` — re-export new types from facade
- **Dependencies added:** None (still pure Rust, zero dependencies)
- **Learnings for future iterations:**
  - Painting methods are impl'd on PathBuilder in a separate file (`painting.rs`) — Rust allows impl blocks across files within same crate
  - `take_and_reset()` uses `std::mem::take()` for efficient Vec drain — avoids clone, resets builder state
  - `close_and_stroke()` / `close_fill_*()` delegate to `close_path()` then the base paint method
  - `n` operator returns `Option<PaintedPath>` (None) — callers can use `if let Some(painted) = ...`
  - Clippy prefers `#[derive(Default)]` + `#[default]` attribute over manual `impl Default` for enums
---

## 2026-02-28 - US-023: Line and Rect extraction from paths
- **What was implemented:**
  - `LineOrientation` enum (Horizontal, Vertical, Diagonal) in `crates/pdfplumber-core/src/shapes.rs`
  - `Line` struct — x0, top, x1, bottom, line_width, stroke_color, orientation (top-left origin)
  - `Rect` struct — x0, top, x1, bottom, line_width, stroke/fill flags, stroke_color, fill_color + width()/height() methods
  - `extract_shapes(painted, page_height) -> (Vec<Line>, Vec<Rect>)` — main extraction function
  - Rectangle detection from axis-aligned closed 4-vertex paths (both `re` operator and manual construction)
  - Line extraction from LineTo segments in stroked paths with y-flip coordinate transformation
  - ClosePath generates closing line segment back to subpath start when needed
  - Handles multiple subpaths (rect + line in same painted path)
  - Curve subpaths produce neither lines nor rects (deferred to US-024)
  - 24 unit tests: horizontal/vertical/diagonal lines, rect from re, rect from 4-line path, fill+stroke rect, non-rect polygons, fill-only paths, multiple subpaths, CTM-transformed rect, edge cases
- **Files changed:**
  - `crates/pdfplumber-core/src/shapes.rs` (new) — Line, Rect, LineOrientation, extract_shapes + 24 tests
  - `crates/pdfplumber-core/src/lib.rs` — added shapes module, re-exports
  - `crates/pdfplumber/src/lib.rs` — re-export new types from facade
- **Dependencies added:** None (still pure Rust, zero dependencies)
- **Learnings for future iterations:**
  - Subpath extraction: split segments at MoveTo boundaries for independent processing
  - Rectangle detection: collect vertices, check all 4 edges are axis-aligned (dx or dy < epsilon)
  - Fill-only non-rectangle paths produce no lines — only stroked paths generate Line objects
  - ClosePath must check start != current before generating a closing line (avoid zero-length lines)
  - `extract_subpaths()` returns slices to avoid cloning — efficient for large paths
---
