# Ralph Progress Log
Started: 2026년  3월  1일 일요일 04시 55분 12초 KST

## Codebase Patterns
- Font metrics: `FontMetrics` struct in `crates/pdfplumber-parse/src/font_metrics.rs`, widths in glyph space (1/1000 em)
- Standard font data: `StandardFontData` in `crates/pdfplumber-parse/src/standard_fonts.rs`, `lookup(name)` returns `Option<&'static StandardFontData>`
- Subset prefix stripping: `crate::cid_font::strip_subset_prefix()` handles `ABCDEF+FontName` patterns
- Width arrays use WinAnsiEncoding char code mapping (most common in modern PDFs)
- Oblique variants share width data with upright: Helvetica-Oblique = Helvetica, Helvetica-BoldOblique = Helvetica-Bold
- All Courier variants share one array (monospaced, all 600)
- Standard font fallback: `lookup_standard_font(font_dict)` in `font_metrics.rs` — reads `/BaseFont`, strips subset prefix, looks up standard widths
- When standard font matched: widths cover codes 0-255, `first_char=0`, `last_char=255`; descriptor values override standard defaults
- pdfplumber-py tests SIGABRT on macOS (pre-existing, unrelated to standard font work)
- Accuracy benchmark: `crates/pdfplumber/tests/accuracy_benchmark.rs`, golden data in `tests/fixtures/golden/`; aggregate F1: chars=0.991, words=0.994

---

## 2026-03-01 - US-103
- Created `crates/pdfplumber-parse/src/standard_fonts.rs` with `StandardFontData` struct and `lookup()` function
- Added static width arrays for all 14 standard Type1 fonts (9 unique arrays, shared via match arms)
- Width data sourced from Adobe AFM specifications, indexed by WinAnsiEncoding char codes
- Registered `pub mod standard_fonts;` in `crates/pdfplumber-parse/src/lib.rs`
- 11 unit tests: known widths, all 14 fonts present, unknown returns None, Courier uniform 600, proportional checks
- Files changed: `crates/pdfplumber-parse/src/standard_fonts.rs` (new), `crates/pdfplumber-parse/src/lib.rs`
- Dependencies added: none
- **Learnings for future iterations:**
  - AFM files use StandardEncoding char codes; need WinAnsiEncoding mapping for modern PDFs
  - Codes 39 (quotesingle vs quoteright) and 96 (grave vs quoteleft) differ between encodings
  - Symbol and ZapfDingbats use their own built-in encodings, not WinAnsiEncoding
---

## 2026-03-01 - US-104
- Integrated standard font fallback in `extract_font_metrics()` in `crates/pdfplumber-parse/src/font_metrics.rs`
- When `/Widths` is absent and `/BaseFont` matches a Standard 14 font, uses standard widths instead of DEFAULT_WIDTH=600
- Added `lookup_standard_font()` helper that reads `/BaseFont`, strips subset prefix, and calls `standard_fonts::lookup()`
- Standard `font_bbox` used as fallback when `/FontDescriptor` lacks bbox; descriptor ascent/descent always takes precedence
- 10 new unit tests covering: Helvetica/Courier/Times-Roman fallback, subset prefix handling, unknown font default, embedded widths unaffected, descriptor overrides, bbox fallback
- Regenerated anytomd golden files (`business-report`, `technical-doc`) — headings now correctly group words (e.g., "# API Reference Guide" instead of separate "# API" "# Reference" "# Guide")
- Files changed: `crates/pdfplumber-parse/src/font_metrics.rs`, `tests/anytomd/fixtures/business-report/expected_markdown.md`, `tests/anytomd/fixtures/technical-doc/expected_markdown.md`
- Dependencies added: none
- **Learnings for future iterations:**
  - Standard font fallback improves text grouping quality — proportional widths produce correct x-positions for word boundary detection
  - `lopdf::Object::as_name()` returns `&[u8]`, needs `std::str::from_utf8()` conversion
  - Existing tests may break when behavior changes are intentional improvements — update assertions to match new correct behavior
---

## 2026-03-01 - US-105
- Ran accuracy benchmark after standard font integration — dramatic improvements across all generated PDFs
- Updated thresholds in `crates/pdfplumber/tests/accuracy_benchmark.rs` to reflect new baselines
- Results summary:
  - basic_text: F1 0.05→1.000, multicolumn: 0.15→1.000, table_lattice: 0.40→1.000
  - table_borderless: 0.40→1.000, table_merged_cells: 0.60→1.000, cjk_mixed: 0.05→1.000
  - long_document: 0.10→1.000, annotations_links: 0.05→1.000
  - multi_font: 0.05→0.588 (non-standard fonts), rotated_pages: 0.01→0.241 (rotation gap)
  - nics-firearm-checks: 0.80→1.000, scotus-transcript: now parses (F1=0.999), pdffill-demo: 1.000
  - Aggregate: chars F1=0.991, words F1=0.994 (exceeds PRD target of 0.95)
- 10/12 PDFs now meet PRD char/word F1>=0.95 target; remaining gaps are multi_font and rotated_pages
- scotus-transcript now parses successfully — updated test from graceful skip to assertion
- Files changed: `crates/pdfplumber/tests/accuracy_benchmark.rs`, `scripts/ralph/prd.json`
- Dependencies added: none
- **Learnings for future iterations:**
  - Standard font width tables are the single biggest accuracy lever for generated PDFs
  - multi_font.pdf uses non-standard fonts — needs embedded font metrics or extended font tables
  - Rotation coordinate transforms remain a separate problem from font metrics
  - scotus-transcript parsing was fixed at some point — always re-test known failures
---
