# Ralph Progress Log
Started: 2026년  3월  1일 일요일 03시 06분 03초 KST
---

## Codebase Patterns
- Text rendering operators (Tj, TJ, ', ") flow: interpret_content_stream → handle_tj/handle_tj_array → emit_char_events → handler.on_char(CharEvent)
- The tokenizer's Operand enum now includes Dictionary(Vec<(String, Operand)>) for inline `<<...>>` dicts
- Marked content state is NOT part of graphics state (q/Q don't save/restore it), so it's tracked as a local `Vec<MarkedContentEntry>` in interpret_content_stream
- To thread new state through char emission: add parameter to handle_tj → handle_tj_array → emit_char_events chain

---

## 2026-03-01 - US-092
- **What was implemented**: Tagged PDF operators (BMC/BDC/EMC) wired in content stream interpreter
  - Added `mcid: Option<u32>` and `tag: Option<String>` to `CharEvent`
  - Added `MarkedContentEntry` struct and `marked_content_stack` in interpreter
  - Implemented BMC (push tag), BDC (push tag+MCID), EMC (pop) operator handlers
  - Updated `emit_char_events` to propagate current mcid/tag to CharEvent
  - Updated `char_from_event` to propagate mcid/tag from event to Char
- **Files changed**:
  - `crates/pdfplumber-parse/src/handler.rs` — mcid/tag fields on CharEvent
  - `crates/pdfplumber-parse/src/interpreter.rs` — BMC/BDC/EMC handlers, marked content stack
  - `crates/pdfplumber-parse/src/char_extraction.rs` — propagate mcid/tag in char_from_event
  - `crates/pdfplumber-parse/src/backend.rs` — updated test CharEvent construction
  - `scripts/ralph/prd.json` — marked US-092 as passes: true
- **Dependencies added**: None
- **Learnings for future iterations:**
  - MCID inheritance in nested content uses `iter().rev().find_map()` to find nearest ancestor with MCID
  - Tag always comes from the innermost (last) stack entry
  - EMC on empty stack is gracefully ignored (no panic)
  - Dictionary parsing in tokenizer was already added in phase 11 (no need to add Dictionary variant again)
---

## 2026-03-01 - US-093
- **What was implemented**: Added `duplicate_merged_content: bool` (default false) to `TableSettings`. Implemented `duplicate_merged_content_in_table()` function that normalizes merged/spanning cells by building a full grid from all unique x/y coordinates, finding the enclosing cell for each grid position, and creating sub-cells with the same text. Integrated into `Page::find_tables()` when the option is enabled.
- **Files changed**:
  - `crates/pdfplumber-core/src/table.rs` — `duplicate_merged_content` field on TableSettings, `duplicate_merged_content_in_table()` function, 7 unit tests (horizontal merge, vertical merge, 2x2 merge, no merge unchanged, disabled option, empty table, default false)
  - `crates/pdfplumber-core/src/lib.rs` — Re-export `duplicate_merged_content_in_table`
  - `crates/pdfplumber/src/page.rs` — Apply duplication in `find_tables()` when option enabled
  - `scripts/ralph/prd.json` — marked US-093 as passes: true
- **Dependencies added**: None
- **Learnings for future iterations:**
  - Merged cells in PDF tables create larger cells covering multiple grid positions (internal borders are missing, so intersections don't exist for sub-grid positions)
  - The grid is determined from all unique x/y coordinates across all cells — this handles any combination of horizontal, vertical, and 2D merges
  - Center-point containment (with epsilon tolerance) is used to match sub-grid positions to enclosing cells
  - `float_key()` function already existed for grouping cells into rows/columns — reused for the new function
---
