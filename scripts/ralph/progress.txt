## Codebase Patterns
- Color is an enum (Gray/Rgb/Cmyk/Other with f32 values), not a struct. Use `.clone()` since it doesn't implement Copy (due to Other(Vec<f32>)).
- Orientation enum lives in geometry.rs. LineOrientation in shapes.rs is a type alias for Orientation.
- All coordinates use f64. Color values use f32.
- BBox uses top-left origin: (x0, top, x1, bottom).
- Char has all PDF fields: text, bbox, fontname, size, doctop, upright, direction, stroking_color, non_stroking_color, ctm ([f64; 6]), char_code (u32).
- Word has doctop (min of char doctops) and direction (from first char).
- Line/Rect/Curve use top/bottom naming (not y0/y1) matching BBox convention.
- When constructing test Char instances, use a helper fn with sensible defaults for the 12 fields.
- PdfError (core) has manual Error impl; BackendError (parse) uses thiserror. Convert between them via From impls.
- ExtractResult<T> wraps value + warnings. Use ExtractResult::ok(val) for clean results.
- PdfBackend trait uses associated functions (no &self). Call as `MyBackend::open(bytes)`, `MyBackend::page_count(&doc)`.
- ContentHandler has default no-op methods. Implementors override only the events they care about.
- ContentHandler is object-safe: use `&mut dyn ContentHandler` in trait method signatures.
- CTM stored as [f64; 6] in event types (CharEvent, PathEvent, ImageEvent) for consistency with Char.ctm.
- LopdfBackend uses BackendError as its Error type (already converts to PdfError via From impl).
- LopdfDocument caches page ObjectIds in a Vec for O(1) 0-based index access (lopdf's get_pages returns BTreeMap<u32, ObjectId> with 1-based keys).
- LopdfDocument.inner() accessor provides read access to the underlying lopdf::Document.
- Create test PDFs programmatically with lopdf: Document::with_version + add_object with dictionary! macro. Save to Vec<u8> with save_to().
- resolve_inherited() walks up page tree via /Parent to find inheritable properties (MediaBox, Rotate, etc.).
- lopdf Object::as_float() returns f32 for both Integer and Real. Use custom object_to_f64() for f64 precision.
- lopdf Dictionary::get(b"Key") takes byte slice key. Returns Result — Err if key missing.
- CropBox is NOT inheritable in practice for this library (read from page dict only). MediaBox and Rotate ARE inherited.
- Content stream tokenizer: `tokenize(&[u8]) -> Result<Vec<Operator>, BackendError>`. Operands accumulated on stack until operator keyword encountered.
- Operand enum: Integer(i64), Real(f64), Name(String), LiteralString(Vec<u8>), HexString(Vec<u8>), Array(Vec<Operand>), Boolean(bool), Null.
- Inline images (BI/ID/EI): dict stored as flattened Array of Name/value pairs, data as LiteralString. Single whitespace byte after ID is the separator.
- PDF whitespace: space, tab, CR, LF, FF (0x0C), NUL (0x00). NUL is whitespace — be careful with binary data boundaries.
- PDF names support #XX hex escapes (e.g., /F#231 → "F#1"). parse_name handles this.
- Use `std::mem::take()` instead of `drain(..).collect()` for moving Vec contents (clippy drain_collect lint).
- InterpreterState (pdfplumber-parse) bundles Ctm + GraphicsState + save/restore stack. Use save_state()/restore_state() for q/Q, concat_matrix() for cm.
- cm operator uses pre-multiplication: new_matrix.concat(&current_ctm). This follows PDF spec where cm modifies CTM by pre-concatenating.
- SC/SCN/sc/scn use component count to infer color space (1→Gray, 3→RGB, 4→CMYK, other→Other).

# Ralph Progress Log
Started: 2026년  2월 28일 토요일 01시 07분 18초 KST
---

## 2026-02-28 - US-002
- What was implemented: Core data model types - Color enum (Gray/Rgb/Cmyk/Other), Orientation enum, zero-size BBox edge case test
- Files changed:
  - crates/pdfplumber-core/src/geometry.rs (added Orientation enum, zero-size BBox test)
  - crates/pdfplumber-core/src/painting.rs (Color struct -> enum with Gray/Rgb/Cmyk/Other variants)
  - crates/pdfplumber-core/src/shapes.rs (LineOrientation -> type alias for Orientation, clone Color)
  - crates/pdfplumber-core/src/edges.rs (use Orientation from geometry)
  - crates/pdfplumber-core/src/lib.rs (export Orientation)
  - crates/pdfplumber/src/lib.rs (re-export Orientation)
- Dependencies added: none
- **Learnings for future iterations:**
  - BBox, TextDirection, LineOrientation already existed in the codebase from Phase 2 work
  - Color was a simple RGB struct - changed to proper PDF color space enum
  - Color can't derive Copy due to Other(Vec<f32>) - need .clone() everywhere it was previously copied
  - Kept LineOrientation as type alias to avoid breaking existing code in pdfplumber crate
---

## 2026-02-28 - US-003
- What was implemented: Extended Char with doctop, upright, direction, stroking_color, non_stroking_color, ctm, char_code fields. Extended Word with doctop, direction. Added construction+field-access tests for Line, Rect, Curve, Edge, Image.
- Files changed:
  - crates/pdfplumber-core/src/text.rs (Char: added 7 new fields, new tests)
  - crates/pdfplumber-core/src/words.rs (Word: added doctop + direction, updated make_word, new tests)
  - crates/pdfplumber-core/src/shapes.rs (added construction tests for Line/Rect/Curve)
  - crates/pdfplumber-core/src/edges.rs (added construction tests for Edge/EdgeSource)
  - crates/pdfplumber-core/src/images.rs (added construction test for Image)
  - crates/pdfplumber-core/src/layout.rs (updated test helper for new Char/Word fields)
  - crates/pdfplumber/src/page.rs (updated test helper for new Char fields)
  - crates/pdfplumber/tests/page_api_integration.rs (updated test helper for new Char fields)
- Dependencies added: none
- **Learnings for future iterations:**
  - Most types already existed from Phase 2 work; US-003 mainly added missing fields to Char/Word
  - Char now has 12 fields - test helpers are essential to avoid verbose test code
  - Word::doctop is computed as min of constituent char doctops during extraction
  - Word::direction is taken from the first char's direction
  - ctm stored as [f64; 6] (not Ctm struct) for simplicity in the Char record
---

## 2026-02-28 - US-004
- What was implemented: Error and warning model - PdfError enum, ExtractWarning, ExtractResult<T>, ExtractOptions in pdfplumber-core. BackendError with thiserror in pdfplumber-parse.
- Files changed:
  - crates/pdfplumber-core/src/error.rs (new - PdfError, ExtractWarning, ExtractResult, ExtractOptions)
  - crates/pdfplumber-core/src/lib.rs (added error module + exports)
  - crates/pdfplumber-parse/src/error.rs (new - BackendError with thiserror)
  - crates/pdfplumber-parse/src/lib.rs (added error module + BackendError export)
  - crates/pdfplumber-parse/Cargo.toml (added thiserror = "2")
  - crates/pdfplumber/src/lib.rs (re-export PdfError, ExtractWarning, ExtractResult, ExtractOptions)
  - scripts/ralph/prd.json (marked US-004 passes: true)
- Dependencies added: thiserror 2 (in pdfplumber-parse only, as approved in PRD)
- **Learnings for future iterations:**
  - pdfplumber-core stays dependency-free: manual Display+Error impls for PdfError
  - PdfError uses String messages (not source errors) to stay Clone+PartialEq
  - From<std::io::Error> for PdfError converts via to_string() (loses original error, but keeps PdfError Clone-able)
  - BackendError in pdfplumber-parse bridges thiserror world with core PdfError
  - ExtractOptions defaults: 10 recursion depth, 100K objects/page, 100MB stream bytes, collect_warnings=true
  - ExtractResult<T>::map() preserves warnings when transforming values
---

## 2026-02-28 - US-005
- What was implemented: PdfBackend trait and ContentHandler trait in pdfplumber-parse
- Files changed:
  - crates/pdfplumber-parse/src/backend.rs (new - PdfBackend trait with 7 methods, associated types Document/Page/Error)
  - crates/pdfplumber-parse/src/handler.rs (new - ContentHandler trait, CharEvent, PathEvent, ImageEvent, PaintOp)
  - crates/pdfplumber-parse/src/lib.rs (added backend + handler modules, exported PdfBackend, ContentHandler, event types)
  - crates/pdfplumber/src/lib.rs (re-export PdfBackend, ContentHandler, CharEvent, PathEvent, ImageEvent, PaintOp)
  - scripts/ralph/prd.json (marked US-005 passes: true)
- Dependencies added: none
- **Learnings for future iterations:**
  - PdfBackend uses associated functions (no &self) with associated types Document, Page, Error
  - Error bound is `std::error::Error + Into<PdfError>` — PdfError itself satisfies this
  - ContentHandler default no-op methods make it easy to subscribe to specific events
  - ContentHandler is object-safe, so `&mut dyn ContentHandler` works in trait signatures
  - Mock backend tests in the same module verify the trait contract effectively
  - Mock types need `#[derive(Debug)]` for `.unwrap_err()` to work in tests
  - CharEvent carries full text state context (matrix, spacing, scaling) for bbox calculation in later layers
  - PathEvent uses Vec<PathSegment> from core and includes paint_op, colors, dash_pattern, fill_rule
  - ImageEvent carries CTM for position/size determination + pixel dimensions and colorspace
---

## 2026-02-28 - US-006
- What was implemented: LopdfBackend struct implementing PdfBackend trait for open/page_count/get_page operations using lopdf crate.
- Files changed:
  - crates/pdfplumber-parse/Cargo.toml (added lopdf = "0.34")
  - crates/pdfplumber-parse/src/lopdf_backend.rs (new - LopdfBackend, LopdfDocument, LopdfPage, create_test_pdf helper, 14 tests)
  - crates/pdfplumber-parse/src/lib.rs (added lopdf_backend module + exports)
  - crates/pdfplumber/src/lib.rs (re-export LopdfBackend, LopdfDocument, LopdfPage)
  - scripts/ralph/prd.json (marked US-006 passes: true)
- Dependencies added: lopdf 0.34 (approved in PRD for default PDF parsing backend)
- **Learnings for future iterations:**
  - lopdf::Document doesn't implement Debug — need manual Debug impl for wrapper types
  - lopdf's get_pages() returns BTreeMap<u32, ObjectId> with 1-based page numbers; cache as Vec for O(1) 0-based access
  - pub(crate) fields still trigger dead_code warning if not read in lib target — use pub accessor methods instead
  - lopdf's Document::load_mem parses PDF from &[u8]; errors are lopdf::Error which must be mapped to BackendError
  - Test PDFs created with lopdf::Document::with_version + dictionary! macro + save_to(&mut Vec<u8>)
  - Stub methods use todo!() for methods that will be implemented in later stories (US-007+)
---

## 2026-02-28 - US-007
- What was implemented: lopdf backend page_media_box, page_crop_box, page_rotate with inheritance support
- Files changed:
  - crates/pdfplumber-parse/src/lopdf_backend.rs (added 3 helper functions + 3 trait method implementations + 5 test PDF builder functions + 11 tests)
  - scripts/ralph/prd.json (marked US-007 passes: true)
- Dependencies added: none
- **Learnings for future iterations:**
  - lopdf get_object() auto-dereferences indirect references; as_dict() casts to dictionary
  - Page tree inheritance: walk /Parent chain for inheritable properties like MediaBox and Rotate
  - lopdf Object::as_i64() only works for Integer (not Real); Object::as_float() works for both but returns f32
  - Custom object_to_f64() helper needed for BBox extraction since we use f64 throughout
  - CropBox is page-level only (no inheritance in this impl); MediaBox and Rotate use inheritance
  - Test PDFs with inheritance: put property on Pages node, omit from Page node
---

## 2026-02-28 - US-008
- What was implemented: Content stream tokenizer — parses PDF content stream bytes into Operator/Operand sequences
- Files changed:
  - crates/pdfplumber-parse/src/tokenizer.rs (new — Operand enum, Operator struct, tokenize() function, 48 tests)
  - crates/pdfplumber-parse/src/lib.rs (added tokenizer module + public exports)
  - scripts/ralph/prd.json (marked US-008 passes: true)
- Dependencies added: none
- **Learnings for future iterations:**
  - PDF content streams interleave operands (pushed onto stack) with operators (consume stack)
  - Operand types: Integer, Real, Name, LiteralString, HexString, Array, Boolean, Null
  - Keywords "true"/"false"/"null" are operands, not operators — handled before operator dispatch
  - Quote operators (' and ") must be matched in keyword parser alongside alphabetic chars
  - f* (fill even-odd) uses asterisk — keyword parser must accept '*' character
  - Inline images (BI/ID/EI) are special: dict entries between BI-ID, raw binary data between ID-EI
  - NUL (0x00) is PDF whitespace — matters for inline image data boundary after ID
  - Literal strings handle balanced parens (depth tracking), escape sequences (\n \r \t \b \f \\ \( \)), octal (\ddd), and line continuations (\CR or \LF)
  - Hex strings: odd digit count gets trailing 0 appended (e.g., <ABC> → <ABC0>)
  - Names support #XX hex escapes (e.g., /F#231 → "F#1")
  - clippy: use std::mem::take() instead of drain(..).collect(), is_some_and() instead of map_or(false, ...)
---

## 2026-02-28 - US-009
- What was implemented: Graphics state stack — InterpreterState combining Ctm + GraphicsState + state stack for q/Q, cm, color operators
- Files changed:
  - crates/pdfplumber-parse/src/interpreter_state.rs (new — InterpreterState struct, 38 tests)
  - crates/pdfplumber-parse/src/lib.rs (added interpreter_state module + InterpreterState export)
  - scripts/ralph/prd.json (marked US-009 passes: true)
- Dependencies added: none
- **Learnings for future iterations:**
  - InterpreterState bundles Ctm + GraphicsState + Vec<SavedState> stack
  - q/Q save/restore both CTM and full GraphicsState (colors, line_width, dash, alpha)
  - cm operator: new_matrix.concat(&current_ctm) — pre-multiplication per PDF spec
  - Color operators map to Color enum variants: G/g→Gray, RG/rg→Rgb, K/k→Cmyk
  - SC/SCN/sc/scn use component count heuristic: 1→Gray, 3→RGB, 4→CMYK, other→Other
  - restore_state() returns bool (false if stack empty) for graceful handling of unbalanced Q
  - ctm_array() converts Ctm struct to [f64; 6] for compatibility with CharEvent/PathEvent/ImageEvent
  - GraphicsState from core already has all needed fields; no core changes were required
---
