## Codebase Patterns

- **PdfBackend trait pattern**: Document-level features add a method to `PdfBackend` trait, implement in `LopdfBackend`, cache result in `Pdf` struct on open, expose via accessor method.
- **Test PDF creation**: Use `lopdf::Document::with_version("1.5")` and `doc.add_object()` to build test PDFs programmatically. Set trailer entries for document-level features.
- **String extraction from lopdf**: Use `Object::String(bytes, _)` matching. Handle UTF-16 BE (BOM 0xFE 0xFF) and Latin-1/UTF-8 fallback. Resolve indirect references before reading.
- **CLI info output**: Text format prints sections with println!, JSON format builds serde_json::Value and prints pretty. New document-level data goes in both formats.
- **Page box pattern**: Page-level optional boxes (TrimBox/BleedBox/ArtBox) follow: add trait method → implement in LopdfBackend with `resolve_inherited()` → add field + accessor to Page → wire up in `Pdf::page()`. Optional boxes use `Option<BBox>`, always-present boxes use `BBox`.
- **Annotation pattern**: Page-level annotations follow: add trait method `page_annotations()` → implement in LopdfBackend parsing /Annots array → add `Vec<Annotation>` field to Page → pass through `from_extraction()`. Each annotation entry may be a direct dict or indirect ref. Extract /Subtype, /Rect, /Contents, /T (author), /M (date).
- **CLI box display**: MediaBox always shown; optional boxes only shown when present. JSON uses conditional insertion (`page_json["key"] = val`). Text uses `if let Some(ref b) = ...`.
- **Hyperlink pattern**: Hyperlinks follow: add `page_hyperlinks()` trait method → implement in LopdfBackend filtering for Link annotations and resolving /A (URI, GoTo) or /Dest → add `Vec<Hyperlink>` field to Page → pass through `from_extraction()`. Skip links without resolvable URIs.
- **CLI subcommand pattern**: New CLI commands: add variant to `Commands` enum in cli.rs → create `<name>_cmd.rs` with `run()`, `write_text()`, `write_json()`, `write_csv()` → wire up in main.rs match. Each output format follows the same structure (header + per-page iteration).
- **Bookmark/outline pattern**: Document-level outlines follow: add `document_bookmarks()` to PdfBackend trait → implement in LopdfBackend walking outline tree via /First, /Next sibling links → cache in Pdf struct on open → expose via `Pdf::bookmarks()`. Resolve destinations using `doc.get_pages()` (1-indexed page map). Handle circular references with visited set + max depth limit.
- **Search pattern**: Text search follows: add types (SearchMatch, SearchOptions) + algorithm (search_chars) in pdfplumber-core/search.rs → add Page::search() delegating to search_chars → add Pdf::search_all() iterating pages. Algorithm: concatenate char texts, map byte offsets→char indices, run regex, compute union bbox from matched chars.
- **Dedupe pattern**: Character deduplication follows: add DedupeOptions struct + dedupe_chars() algorithm in pdfplumber-core/dedupe.rs → add Page::dedupe_chars() and CroppedPage::dedupe_chars() returning CroppedPage with filtered chars. Algorithm: iterate chars, check each against kept list (same text, positions within tolerance, extra_attrs match), keep first occurrence. Uses from_page_data() helper to build CroppedPage without coordinate adjustment.
- **ExtractOptions pattern**: Document-level extraction settings go in ExtractOptions (set at Pdf::open() time, used during Pdf::page()). For text processing options (normalization, etc.), add field to ExtractOptions, apply in Pdf::page() after char creation. CLI: add separate clap ValueEnum arg type with conversion method, use open_pdf_with_norm() helper.

# Ralph Progress Log
Started: 2026년  2월 28일 토요일 15시 35분 07초 KST
---

## 2026-02-28 - US-058
- Implemented PDF document metadata access
- Files changed:
  - `crates/pdfplumber-core/src/metadata.rs` (NEW) — DocumentMetadata struct
  - `crates/pdfplumber-core/src/lib.rs` — Added metadata module and export
  - `crates/pdfplumber-parse/src/backend.rs` — Added `document_metadata()` to PdfBackend trait
  - `crates/pdfplumber-parse/src/lopdf_backend.rs` — Implemented metadata extraction from /Info dictionary
  - `crates/pdfplumber/src/pdf.rs` — Added metadata field to Pdf struct, caches on open
  - `crates/pdfplumber/src/lib.rs` — Re-exported DocumentMetadata
  - `crates/pdfplumber-cli/src/info_cmd.rs` — Added metadata display (text + JSON formats)
  - `crates/pdfplumber/tests/pdf_integration.rs` — 3 integration tests
  - `crates/pdfplumber-cli/tests/info_cmd.rs` — 4 CLI tests
- Dependencies added: None
- **Learnings for future iterations:**
  - lopdf /Info dictionary is accessed via `doc.trailer.get(b"Info")` → Reference → Dictionary
  - PDF strings may be UTF-16 BE with BOM (0xFE 0xFF) — must handle encoding
  - `Object::string_literal()` creates PDF string objects in lopdf for test PDFs
  - Document-level features follow pattern: trait method → backend impl → Pdf facade cache + accessor
---

## 2026-02-28 - US-059
- Implemented page box variants: TrimBox, BleedBox, ArtBox
- Files changed:
  - `crates/pdfplumber-parse/src/backend.rs` — Added `page_trim_box()`, `page_bleed_box()`, `page_art_box()` to PdfBackend trait + mock
  - `crates/pdfplumber-parse/src/lopdf_backend.rs` — Implemented extraction with `resolve_inherited()` for all three boxes
  - `crates/pdfplumber/src/page.rs` — Added `media_box`, `crop_box`, `trim_box`, `bleed_box`, `art_box` fields + accessors
  - `crates/pdfplumber/src/pdf.rs` — Fetches all five boxes and passes to `Page::from_extraction()`
  - `crates/pdfplumber-cli/src/info_cmd.rs` — Displays all page boxes in text + JSON formats
  - `crates/pdfplumber/tests/pdf_integration.rs` — 3 integration tests (all boxes, only MediaBox, inheritance)
  - `crates/pdfplumber-cli/tests/info_cmd.rs` — 4 CLI tests (text/JSON presence + absence)
- Dependencies added: None
- **Learnings for future iterations:**
  - All box types can use `resolve_inherited()` for walking up the page tree (parent → grandparent)
  - `Page::from_extraction()` already had `#[allow(clippy::too_many_arguments)]` — adding 5 box params is acceptable
  - BBox is `Copy` so cheap to pass by value; `Option<BBox>` works well for optional boxes
  - lopdf `dictionary!` macro accepts `vec![Object::Integer(..)]` for array values directly
---

## 2026-02-28 - US-060
- Implemented annotation extraction from pages
- Files changed:
  - `crates/pdfplumber-core/src/annotation.rs` (NEW) — Annotation struct, AnnotationType enum
  - `crates/pdfplumber-core/src/lib.rs` — Added annotation module and exports
  - `crates/pdfplumber-parse/src/backend.rs` — Added `page_annotations()` to PdfBackend trait + mock
  - `crates/pdfplumber-parse/src/lopdf_backend.rs` — Implemented annotation extraction from /Annots array
  - `crates/pdfplumber/src/page.rs` — Added `annotations` field + `annots()` accessor
  - `crates/pdfplumber/src/pdf.rs` — Calls `page_annotations()` in `Pdf::page()`, passes to `from_extraction()`
  - `crates/pdfplumber/src/lib.rs` — Re-exported Annotation, AnnotationType
  - `crates/pdfplumber/tests/pdf_integration.rs` — 3 integration tests (Text, Highlight, no annotations)
- Dependencies added: None
- **Learnings for future iterations:**
  - Annotations are in the /Annots array on the page dictionary (not inherited)
  - Each annotation entry can be a direct dictionary or indirect reference — must handle both
  - /Subtype is a Name object (not String) — use `Object::Name` matching
  - /T is the author field, /M is the modification date, /Contents is the text content
  - `extract_string_from_dict()` helper handles both String and Name object types with UTF-16 BE support
  - Test PDFs can set /Annots as vec![Object::Reference(annot_id)] in the page dictionary
---

## 2026-02-28 - US-061
- Implemented hyperlink extraction from Link annotations
- Files changed:
  - `crates/pdfplumber-core/src/hyperlink.rs` (NEW) — Hyperlink struct
  - `crates/pdfplumber-core/src/lib.rs` — Added hyperlink module and export
  - `crates/pdfplumber-parse/src/backend.rs` — Added `page_hyperlinks()` to PdfBackend trait + mock
  - `crates/pdfplumber-parse/src/lopdf_backend.rs` — Implemented hyperlink extraction: resolve /A (URI, GoTo, GoToR) and /Dest
  - `crates/pdfplumber/src/page.rs` — Added `hyperlinks` field + `hyperlinks()` accessor
  - `crates/pdfplumber/src/pdf.rs` — Calls `page_hyperlinks()` in `Pdf::page()`, passes to `from_extraction()`
  - `crates/pdfplumber/src/lib.rs` — Re-exported Hyperlink
  - `crates/pdfplumber/tests/pdf_integration.rs` — 3 integration tests (URI link, GoTo link, no links)
  - `crates/pdfplumber-cli/src/cli.rs` — Added Annots and Links subcommands with --format json/text/csv
  - `crates/pdfplumber-cli/src/annots_cmd.rs` (NEW) — Annotations CLI command
  - `crates/pdfplumber-cli/src/links_cmd.rs` (NEW) — Hyperlinks CLI command
  - `crates/pdfplumber-cli/src/main.rs` — Wired up annots and links commands
  - `crates/pdfplumber-cli/tests/annots_cmd.rs` (NEW) — 4 CLI tests for annots
  - `crates/pdfplumber-cli/tests/links_cmd.rs` (NEW) — 4 CLI tests for links
- Dependencies added: None
- **Learnings for future iterations:**
  - Hyperlinks are a subset of Link annotations with resolved URIs
  - Link annotations can have /A (Action) dict with /S type: URI, GoTo, GoToR
  - /A /URI /URI gives the URL string directly
  - /A /GoTo /D gives a destination array [page_ref, /type, ...] — resolve page_ref to page number via doc.get_pages()
  - /Dest on the annotation is a direct destination (no action dict)
  - Annotations without resolvable actions/dests are skipped (graceful handling)
  - `page_hyperlinks()` follows the same backend trait pattern as `page_annotations()`
---

## 2026-02-28 - US-062
- Implemented bookmark / outline / table of contents extraction
- Files changed:
  - `crates/pdfplumber-core/src/bookmark.rs` (NEW) — Bookmark struct
  - `crates/pdfplumber-core/src/lib.rs` — Added bookmark module and export
  - `crates/pdfplumber-parse/src/backend.rs` — Added `document_bookmarks()` to PdfBackend trait + mock
  - `crates/pdfplumber-parse/src/lopdf_backend.rs` — Implemented outline tree walking with destination resolution
  - `crates/pdfplumber/src/pdf.rs` — Added bookmarks field to Pdf struct, caches on open, `bookmarks()` accessor
  - `crates/pdfplumber/src/lib.rs` — Re-exported Bookmark
  - `crates/pdfplumber/tests/pdf_integration.rs` — 3 integration tests (multi-level, no outlines, GoTo action)
  - `crates/pdfplumber-cli/src/cli.rs` — Added Bookmarks subcommand with --format json/text
  - `crates/pdfplumber-cli/src/bookmarks_cmd.rs` (NEW) — Bookmarks CLI command
  - `crates/pdfplumber-cli/src/main.rs` — Wired up bookmarks command
  - `crates/pdfplumber-cli/tests/bookmarks_cmd.rs` (NEW) — 3 CLI tests
- Dependencies added: None
- **Learnings for future iterations:**
  - Outlines are document-level (not page-level), accessed via catalog /Outlines
  - Outline tree uses /First (first child), /Next (next sibling) links — walk iteratively with visited set
  - lopdf `doc.get_pages()` returns BTreeMap<u32, ObjectId> with 1-indexed page numbers
  - Destinations can be explicit arrays `[page_ref, /type, ...]` or named destinations
  - /XYZ destination type has `[page, /XYZ, left, top, zoom]` — top is at index 3
  - /FitH and /FitBH have `[page, /type, top]` — top is at index 2
  - Named destinations are looked up in catalog /Names → /Dests name tree or catalog /Dests dictionary
  - Circular reference protection: visited set + max_depth (64) + max_siblings (10,000) limits
  - Bookmarks follow the metadata pattern: document-level, cached on open, exposed via accessor
---

## 2026-02-28 - US-063
- Implemented text search with position (regex and literal, case-sensitive/insensitive)
- Files changed:
  - `crates/pdfplumber-core/src/search.rs` (NEW) — SearchMatch, SearchOptions structs, search_chars() algorithm
  - `crates/pdfplumber-core/src/lib.rs` — Added search module and exports
  - `crates/pdfplumber-core/Cargo.toml` — Added `regex` dependency
  - `crates/pdfplumber/src/page.rs` — Added `Page::search()` method
  - `crates/pdfplumber/src/pdf.rs` — Added `Pdf::search_all()` method
  - `crates/pdfplumber/src/lib.rs` — Re-exported SearchMatch, SearchOptions
  - `crates/pdfplumber/tests/pdf_integration.rs` — 5 integration tests (literal, regex, case-insensitive, no match, multi-page)
  - `crates/pdfplumber-cli/src/cli.rs` — Added Search subcommand with --pages, --case-insensitive, --no-regex, --format
  - `crates/pdfplumber-cli/src/search_cmd.rs` (NEW) — Search CLI command with text/json/csv output
  - `crates/pdfplumber-cli/src/main.rs` — Wired up search command
  - `crates/pdfplumber-cli/tests/search_cmd.rs` (NEW) — 6 CLI tests (text/json/csv, no match, case-insensitive, regex)
- Dependencies added: `regex = "1"` (to pdfplumber-core)
- **Learnings for future iterations:**
  - Search algorithm: concatenate all char texts, build byte-offset→char-index mapping, run regex, map matches back to char bboxes
  - Use `regex::escape()` for literal string search to avoid regex injection
  - `BBox::union()` is perfect for computing match bounding boxes from constituent chars
  - The `regex` crate supports `(?i)` prefix for case-insensitive matching
  - Invalid regex patterns return empty results (graceful degradation)
  - Page::search() delegates to search_chars() with the page's chars and page_number
  - Pdf::search_all() iterates all pages and collects matches
---

## 2026-02-28 - US-064
- Implemented duplicate character deduplication
- Files changed:
  - `crates/pdfplumber-core/src/dedupe.rs` (NEW) — DedupeOptions struct, dedupe_chars() algorithm
  - `crates/pdfplumber-core/src/lib.rs` — Added dedupe module and exports
  - `crates/pdfplumber/src/page.rs` — Added Page::dedupe_chars() method
  - `crates/pdfplumber/src/cropped_page.rs` — Added CroppedPage::dedupe_chars() method + from_page_data() helper
  - `crates/pdfplumber/src/lib.rs` — Re-exported DedupeOptions
  - `crates/pdfplumber/tests/pdf_integration.rs` — 3 integration tests (overlapping deduped, non-overlapping preserved, different font not deduped)
- Dependencies added: None
- **Learnings for future iterations:**
  - Deduplication is a pure character filter — no backend trait changes needed
  - The algorithm is O(n*k) where n=total chars, k=kept chars; fine for typical PDF pages
  - CroppedPage can be constructed without coordinate adjustment via from_page_data() helper
  - DedupeOptions uses Vec<String> for extra_attrs to match Python's flexible attribute matching
  - Position comparison uses x0 and top within tolerance (not full bbox overlap)
  - Different text content at same position is NOT deduped (e.g., overlapping "A" and "B")
---

## 2026-02-28 - US-065
- Implemented Unicode normalization option for extracted text
- Files changed:
  - `crates/pdfplumber-core/src/unicode_norm.rs` (NEW) — UnicodeNorm enum, normalize() method, normalize_chars() function
  - `crates/pdfplumber-core/src/lib.rs` — Added unicode_norm module and exports
  - `crates/pdfplumber-core/src/error.rs` — Added unicode_norm field to ExtractOptions
  - `crates/pdfplumber-core/Cargo.toml` — Added `unicode-normalization = "0.1"` dependency
  - `crates/pdfplumber/src/pdf.rs` — Apply normalization after char extraction in Pdf::page()
  - `crates/pdfplumber/src/lib.rs` — Re-exported UnicodeNorm
  - `crates/pdfplumber/tests/pdf_integration.rs` — 3 integration tests (NFC, NFKC, None)
  - `crates/pdfplumber-cli/src/cli.rs` — Added UnicodeNormArg enum, --unicode-norm flag to Text/Chars/Words subcommands, 6 CLI tests
  - `crates/pdfplumber-cli/src/shared.rs` — Added open_pdf_with_norm() helper
  - `crates/pdfplumber-cli/src/text_cmd.rs` — Accept unicode_norm parameter
  - `crates/pdfplumber-cli/src/chars_cmd.rs` — Accept unicode_norm parameter
  - `crates/pdfplumber-cli/src/words_cmd.rs` — Accept unicode_norm parameter
  - `crates/pdfplumber-cli/src/main.rs` — Wire up unicode_norm for Text/Chars/Words commands
- Dependencies added: `unicode-normalization = "0.1"` (standard Rust unicode normalization crate)
- **Learnings for future iterations:**
  - Unicode normalization is best applied at extraction time in Pdf::page(), after chars are created — all downstream consumers get normalized text automatically
  - UnicodeNorm enum added to ExtractOptions (document-level setting), set at Pdf::open() time
  - CLI uses a separate UnicodeNormArg enum for clap ValueEnum, with to_unicode_norm() conversion method
  - open_pdf_with_norm() helper avoids modifying the existing open_pdf() signature
  - NFC composes decomposed chars (e + combining accent → é), NFKC additionally decomposes ligatures (ﬁ → fi) and fullwidth chars (Ａ → A)
---
